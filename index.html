<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vapo'Chill ‚Äì Suivi commandes</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --vc-dark:#0f2a22;
      --vc-green:#2bb673;
      --vc-mint:#e6f6ef;
      --vc-danger:#b00020;
      --vc-card:#ffffff;
      --vc-border:#dfe7e3;
      --vc-text:#10211b;
      --vc-muted:#5d6b66;

      --vc-blue:#4a7dff;
      --vc-yellow:#f6c453;
      --vc-red:#ff6b6b;
      --vc-orange:#ff9a3c;
      --vc-purple:#b9a7ff;
    }

    * { box-sizing:border-box; }
    body { font-family: 'Inter', Arial, sans-serif; margin:0; background:var(--vc-mint); color:var(--vc-text); }

    /* ===== TOP BAR (fixe) ===== */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      height:64px; background:var(--vc-dark); color:#fff;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px; z-index:1000;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      gap:10px;
    }
    .topbar-left{ display:flex; align-items:center; gap:12px; }
    .topbar img{ height:40px; background:#fff; padding:4px; border-radius:10px; }
    .topbar-title{ display:flex; flex-direction:column; line-height:1.1; }
    .topbar-title b{ font-size:14px; }
    .topbar-title span{ font-size:12px; opacity:.9; }

    .topbar-right{
      display:flex; gap:10px; font-size:12px; opacity:.98;
      align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .chip{
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      padding:6px 10px;
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }

    .wrap { padding: 86px 18px 18px; max-width: 1280px; margin: 0 auto; }
    .small { font-size: 12px; color:var(--vc-muted); white-space:pre-wrap; }
    .card { background:var(--vc-card); border:1px solid var(--vc-border); border-radius:16px; padding:14px; margin: 12px 0; box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { font-size: 12px; color:#32423d; display:block; margin-bottom:4px; }

    input, select, textarea {
      padding: 8px; border:1px solid #cfd8d3; border-radius:12px;
      width: 240px; background:#fff; font-family: inherit;
    }
    textarea { width: 520px; height: 70px; }

    button { padding:10px 12px; border:0; border-radius:12px; cursor:pointer; font-weight:600; }
    .primary { background:var(--vc-dark); color:#fff; }
    .light { background:#eef1f0; }
    .danger { background:var(--vc-danger); color:#fff; }
    .ok { background:var(--vc-green); color:#fff; }

    .hidden{ display:none !important; }

    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom:1px solid #eef2f0; padding:10px; text-align:left; vertical-align: top; }
    th { font-size: 12px; color:#3f4c48; }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #d7e0db; background:#f6f8f7; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .right { margin-left:auto; }

    /* Statuts */
    .st { font-weight: 800; }
    .st-mec { border-color:rgba(246,196,83,.55); background:rgba(246,196,83,.22); color:#6b4a00; }
    .st-com { border-color:rgba(74,125,255,.45); background:rgba(74,125,255,.16); color:#1837a8; }
    .st-rup { border-color:rgba(255,107,107,.55); background:rgba(255,107,107,.18); color:#8a1010; }
    .st-par { border-color:rgba(185,167,255,.55); background:rgba(185,167,255,.18); color:#3c2aa8; }

    /* Re√ßu */
    .receivedTag { border-color: rgba(43,182,115,.35); background: rgba(43,182,115,.12); font-weight:900; }
    .row-received { outline: 2px solid rgba(43,182,115,.25); outline-offset: -2px; animation: flash .35s ease; }
    @keyframes flash { from { background: rgba(43,182,115,.10); } to { background: transparent; } }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tab { padding:8px 10px; border-radius:999px; border:1px solid #d7e0db; background:#f6f8f7; cursor:pointer; font-size:12px; user-select:none; }
    .tab.active { background:var(--vc-dark); color:#fff; border-color:var(--vc-dark); }

    /* Checkbox */
    .cb { display:flex; align-items:center; gap:8px; font-size:12px; color:#2f3a36; user-select:none; }
    .cb input { width:auto; transform: scale(1.15); }

    /* Dashboard */
    .dashboard{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap:12px;
      margin: 12px 0;
    }
    .statCard{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .statCard .label{ font-size:12px; color:var(--vc-muted); font-weight:700; display:flex; align-items:center; gap:8px; }
    .statCard .value{ font-size:22px; font-weight:900; }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .dot.mec{ background: var(--vc-yellow); }
    .dot.com{ background: var(--vc-blue); }
    .dot.rup{ background: var(--vc-red); }
    .dot.recu{ background: var(--vc-green); }

    /* ===== MODALS ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:16px;
    }
    .modal{
      width:min(820px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--vc-border);
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      overflow:hidden;
      transform: translateY(6px);
      animation: pop .14s ease-out;
    }
    @keyframes pop{
      from{ transform: translateY(16px); opacity:.7; }
      to{ transform: translateY(6px); opacity:1; }
    }
    .modalHeader{
      background: #f6f8f7;
      border-bottom:1px solid var(--vc-border);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader b{ font-size:14px; }
    .modalBody{ padding:14px 16px; }
    .modalFooter{
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      border-top:1px solid var(--vc-border);
      background:#fff;
      align-items:center;
    }

    .waBox{
      border:1px solid var(--vc-border);
      background:#fbfcfb;
      border-radius:14px;
      padding:12px;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.45;
      width:100%;
      min-height: 220px;
      resize:vertical;
      font-family: inherit;
    }

    .toggleRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      font-size:12px;
      color:#2f3a36;
    }
    .toggleRow input{ transform: scale(1.15); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field input, .field textarea, .field select{ width:100%; }

    @media (max-width: 900px){
      .grid2{ grid-template-columns:1fr; }
    }
    @media (max-width: 700px){
      input, select, textarea { width: 100%; }
      textarea { width: 100%; }
      .topbar-right { gap:6px; }
    }

    /* =========================
       LOGIN ‚Äî SOBRE LUXE
       ========================= */
    .loginStage{
      min-height: calc(100vh - 86px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px 0;
    }

    .loginShell{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:16px;
      align-items:stretch;
    }

    .loginHero{
      border-radius:22px;
      padding:22px;
      color:#fff;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(43,182,115,.35), transparent 55%),
        radial-gradient(700px 380px at 90% 40%, rgba(74,125,255,.22), transparent 55%),
        linear-gradient(135deg, #0f2a22, #12382c);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
      position:relative;
    }

    .heroTop{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .heroLogo{
      width:44px;height:44px;
      border-radius:14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:-.02em;
    }

    .heroTitle{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .heroTitle b{ font-size:13px; opacity:.95; }
    .heroTitle span{ font-size:12px; opacity:.82; }

    .loginHero h1{
      margin:16px 0 8px;
      font-size:28px;
      letter-spacing:-.02em;
      line-height:1.1;
    }
    .loginHero p{
      margin:0;
      opacity:.9;
      font-size:13px;
      line-height:1.55;
      max-width: 46ch;
    }

    .heroFoot{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      opacity:.96;
      font-size:12px;
    }
    .heroChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
    }

    .loginCard{
      background:var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:20px;
      box-shadow: 0 18px 55px rgba(0,0,0,.08);
    }

    .loginCard h2{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:-.01em;
    }
    .loginCard .sub{
      font-size:12px;
      color:var(--vc-muted);
    }

    .loginGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:14px;
    }

    .fieldBox{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .fieldBox label{
      font-size:12px;
      color:#32423d;
      font-weight:800;
    }

    .inputWrap{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid #cfd8d3;
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .inputWrap:focus-within{
      border-color: rgba(15,42,34,.55);
      box-shadow: 0 0 0 4px rgba(15,42,34,.10);
    }
    .inputIcon{
      font-size:14px;
      opacity:.75;
      width:18px;
      text-align:center;
    }

    .inputWrap input{
      border:0 !important;
      outline:none !important;
      width:100%;
      padding:0 !important;
      border-radius:0 !important;
      background:transparent !important;
      font-family:inherit;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
      align-items:center;
    }

    .btnPrimary{
      background:var(--vc-dark);
      color:#fff;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .05s ease, opacity .12s ease;
    }
    .btnPrimary:active{ transform: translateY(1px); }
    .btnPrimary[disabled]{ opacity:.6; cursor:not-allowed; }

    .btnGhost{
      background:#eef1f0;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
    }

    .alert{
      margin-top:10px;
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      border:1px solid rgba(176,0,32,.22);
      background: rgba(176,0,32,.06);
      color:#7c0016;
      display:none;
      white-space:pre-wrap;
    }
    .alert.show{ display:block; }

    .loginHint{
      margin-top:10px;
      font-size:12px;
      color:var(--vc-muted);
      line-height:1.45;
    }

    @media (max-width: 900px){
      .loginShell{ grid-template-columns:1fr; }
    }

    /* =========================
       HUB APPS (MENU)
       ========================= */
    .hubStage{
      min-height: calc(100vh - 86px);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 26px 0;
    }
    .hubShell{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .hubHeader{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:18px 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .hubHeader b{ font-size:16px; }
    .hubHeader .small{ margin-top:4px; }
    .hubGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:14px;
    }
    .appTile{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 160px;
    }
    .appTile .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .appIcon{
      width:42px;height:42px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(15,42,34,.08);
      border:1px solid rgba(15,42,34,.12);
      font-size:18px;
    }
    .appTile h3{
      margin:0;
      font-size:14px;
      letter-spacing:-.01em;
    }
    .appTile p{
      margin:0;
      font-size:12px;
      color: var(--vc-muted);
      line-height:1.45;
      max-width: 60ch;
    }
    .appTile .actions{
      margin-top:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Barre retour dans les applis */
    .appTopActions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 2px;
    }
    .backBtn{
      background:#eef1f0;
      border:0;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }

    /* =========================
       APP 2 : CAISSE ‚Äî UI PRO
       ========================= */
    .cashWrap{ display:flex; flex-direction:column; gap:12px; }

    .cashHeader{
      background: linear-gradient(135deg, rgba(15,42,34,.96), rgba(18,56,44,.96));
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
      border-radius:22px;
      padding:16px 16px;
      box-shadow: 0 18px 55px rgba(0,0,0,.10);
      position:relative;
      overflow:hidden;
    }
    .cashHeader:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 320px at 15% 35%, rgba(43,182,115,.28), transparent 60%),
        radial-gradient(680px 340px at 85% 35%, rgba(74,125,255,.20), transparent 60%);
      pointer-events:none;
    }
    .cashHeader > *{ position:relative; }

    .cashHeaderTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .cashTitle b{ font-size:18px; }
    .cashTitle .small{ color: rgba(255,255,255,.85); }

    .cashBadges{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }
    .cashBadge{
      display:flex;
      align-items:center;
      gap:10px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      font-size:12px;
      white-space:nowrap;
    }
    .cashDot{ width:10px; height:10px; border-radius:50%; background: rgba(43,182,115,.9); }

    .cashKpis{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:12px;
    }
    .cashKpi{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(255,255,255,.30);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.08);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      color: var(--vc-text);
    }
    .cashKpi .label{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      font-size:12px;
      color: var(--vc-muted);
    }
    .cashIcon{
      width:30px; height:30px;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(15,42,34,.08);
      border:1px solid rgba(15,42,34,.12);
      font-size:14px;
    }
    .cashKpi .value{
      font-size:26px;
      font-weight:900;
      letter-spacing:-.02em;
      color: var(--vc-text);
      line-height:1.05;
    }

    .cashGrid2{
      display:grid;
      grid-template-columns: 1.15fr 1fr;
      gap:12px;
      align-items:start;
    }
    .cashPanel{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }
    .cashPanelHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .cashInputsRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap:10px;
      margin-top:10px;
      align-items:end;
    }
    .cashInputsRow input{ width:100%; }

    .cashPreview{
      width:100%;
      min-height: 260px;
      resize:vertical;
      border-radius:16px;
      border:1px solid var(--vc-border);
      padding:12px;
      background:#fbfcfb;
      font-family: inherit;
      font-size:13px;
      line-height:1.45;
    }

    .badgeOk{
      border:1px solid rgba(43,182,115,.35);
      background: rgba(43,182,115,.12);
      color:#0f5a32;
      font-weight:900;
    }
    .badgeErr{
      border:1px solid rgba(255,107,107,.45);
      background: rgba(255,107,107,.14);
      color:#7a1212;
      font-weight:900;
    }
    .rowErr{
      outline: 2px solid rgba(255,107,107,.22);
      outline-offset: -2px;
    }

    @media (max-width: 980px){
      .cashGrid2{ grid-template-columns:1fr; }
      .cashInputsRow{ grid-template-columns:1fr 1fr; }
    }

    @media print{
      body{ background:#fff !important; }
      .topbar, #hubRoot, #loginCard, #appRoot{ display:none !important; }
      #cashRoot{ display:block !important; }
      .appTopActions{ display:none !important; }
      button, select, input{ display:none !important; }
      .cashHeader, .cashPanel, .cashKpi{ box-shadow:none !important; }
      textarea{ border:1px solid #ddd !important; }
    }

    /* =========================
       APP 2 : CAISSE ‚Äî REFONTE (v2)
       - 2 colonnes
       - email preview + √©tat visible
       - header lisible (badges)
       - comptage compact
       ========================= */

    /* Header App2: badges lisibles sur fond fonc√© */
    .cashHeader .pill{
      color:#fff !important;
      background: rgba(255,255,255,.10) !important;
      border-color: rgba(255,255,255,.22) !important;
    }

    .cashGridMain{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .cashGridMain{ grid-template-columns:1fr; }
    }

    .cashStateCard{
      background: linear-gradient(135deg, rgba(15,42,34,.96), rgba(18,56,44,.96));
      color:#fff;
      border-radius:22px;
      padding:16px;
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      position:relative;
      overflow:hidden;
    }
    .cashStateCard:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 300px at 15% 30%, rgba(43,182,115,.35), transparent 60%),
        radial-gradient(600px 300px at 85% 70%, rgba(255,107,107,.30), transparent 60%),
        radial-gradient(700px 350px at 85% 15%, rgba(74,125,255,.18), transparent 60%);
      pointer-events:none;
    }
    .cashStateCard > *{ position:relative; }

    .cashStateTop{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start; }
    .cashBigBadge{
      padding:10px 16px;
      border-radius:999px;
      font-weight:1000;
      font-size:14px;
      border:1px solid rgba(255,255,255,.25);
      background: rgba(255,255,255,.12);
      white-space:nowrap;
    }

    .cashStateNumbers{
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:10px;
    }
    @media (max-width: 520px){
      .cashStateNumbers{ grid-template-columns:1fr; }
    }

    .cashNum{
      background:#fff;
      color:#10211b;
      border-radius:18px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.10);
      border:1px solid rgba(255,255,255,.30);
    }
    .cashNum .label{ font-size:12px; color:#5d6b66; font-weight:900; }
    .cashNum .value{ font-size:24px; font-weight:1000; margin-top:4px; letter-spacing:-.02em; }

    .cashEmailCard textarea{
      width:100%;
      min-height: 230px;
      resize:vertical;
      border-radius:16px;
      border:1px solid var(--vc-border);
      padding:12px;
      background:#fbfcfb;
      font-family: inherit;
      font-size:13px;
      line-height:1.45;
    }

    /* table comptage compacte */
    .cashCompact table th,
    .cashCompact table td{ padding:8px 10px; }
    .cashCompact table th{ font-size:11px; }
    .cashDenomPill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #d7e0db;
      background:#f6f8f7;
      font-size:12px;
      font-weight:900;
    }
    .cashQty{ width:92px !important; padding:8px 10px !important; border-radius:12px; }
    .cashSubSmall{ font-size:12px; color: var(--vc-muted); font-weight:900; white-space:nowrap; }
    .cashQty:focus{ outline:none; border-color: rgba(15,42,34,.55); box-shadow: 0 0 0 4px rgba(15,42,34,.10); }

    /* Admin read-only hint */
    .cashReadOnlyHint{
      display:block;
      margin-top:8px;
      font-size:12px;
      font-weight:900;
      color:#7a1212;
    }

  </style>
</head>
<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-left">
      <img src="./logo-vapochill.jpeg" alt="Vapo'Chill" onerror="this.style.display='none'">
      <div class="topbar-title">
        <b id="uiTitle">Vapo'Chill ‚Äì Connexion</b>
        <span id="uiSub">‚Äî</span>
      </div>
    </div>

    <div class="topbar-right">
      <button class="light hidden" style="padding:8px 10px;border-radius:999px" id="btnSettings" type="button">‚öôÔ∏è Param√®tres</button>

      <div class="chip">üïí <span id="clock">--:--</span></div>
      <div class="chip">üë§ <span id="userLabel">non connect√©</span></div>
      <button class="light hidden" style="padding:8px 10px;border-radius:999px" id="btnLogout" type="button">D√©connexion</button>
    </div>
  </div>

  <div class="wrap">

    <!-- ====== LOGIN ====== -->
    <div class="loginStage" id="loginCard">
      <div class="loginShell">

        <div class="loginHero">
          <div>
            <div class="heroTop">
              <div class="heroLogo">VC</div>
              <div class="heroTitle">
                <b>Vapo‚ÄôChill</b>
                <span>Suivi commandes interne</span>
              </div>
            </div>

            <h1>Connexion</h1>
            <p>
              Acc√®de √† la gestion des commandes, statuts, historique et messages WhatsApp.
              Interface pens√©e pour aller vite, sans erreurs.
            </p>
          </div>

          <div class="heroFoot">
            <div class="heroChip">üîê Acc√®s s√©curis√©</div>
            <div class="heroChip">‚ö° Rapide</div>
            <div class="heroChip">üì¶ Suivi clair</div>
          </div>
        </div>

        <div class="loginCard">
          <h2>Se connecter</h2>
          <div class="sub">Email boutique ou admin.</div>

          <div class="loginGrid">
            <div class="fieldBox">
              <label>Email</label>
              <div class="inputWrap">
                <div class="inputIcon">‚úâÔ∏è</div>
                <input id="email" placeholder="boutique.tours@vapochill.fr" autocomplete="username">
              </div>
            </div>

            <div class="fieldBox">
              <label>Mot de passe</label>
              <div class="inputWrap">
                <div class="inputIcon">üîí</div>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
              </div>
            </div>

            <div class="btnRow">
              <button id="btnLogin" class="btnPrimary" type="button">Se connecter</button>
              <button class="btnGhost" id="btnReset" type="button">Mot de passe oubli√©</button>
            </div>

            <div class="alert" id="authAlert"></div>
            <div class="small" id="authMsg"></div>

            <!-- Reset password block -->
            <div class="card hidden" id="resetCard" style="margin-top:12px">
              <b>üîí D√©finir un nouveau mot de passe</b>
              <div class="small" style="margin-top:6px">Ce bloc s‚Äôaffiche quand tu arrives via un lien de r√©cup√©ration.</div>
              <div style="height:10px"></div>
              <label>Nouveau mot de passe</label>
              <input id="newPassword" type="password" style="width:100%" placeholder="Nouveau mot de passe">
              <div class="row" style="margin-top:10px">
                <button class="ok" id="btnUpdatePass" type="button">Enregistrer</button>
                <span class="small" id="resetMsg"></span>
              </div>
            </div>

            <!-- Debug (optionnel) -->
            <div class="card hidden" style="margin-top:12px" id="debugCard">
              <b style="font-size:13px;">Debug</b>
              <div class="small" id="debug">‚Äî</div>
            </div>

            <div class="loginHint">
              Astuce : si une boutique ‚Äúne voit rien‚Äù, actualise la page ou appel Alan.
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===============================
         HUB / MENU DES APPLICATIONS
         =============================== -->
    <div class="hidden" id="hubRoot">
      <div class="hubStage">
        <div class="hubShell">

          <div class="hubHeader">
            <div>
              <b>Applications internes</b>
              <div class="small">Choisis l‚Äôapplication √† ouvrir.</div>
            </div>
            <div class="actions"></div>
          </div>

          <div class="hubGrid">
            <!-- App 1 -->
            <div class="appTile">
              <div class="top">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div class="appIcon">üì¶</div>
                  <div>
                    <h3>Commandes clients</h3>
                    <p>Cr√©er, suivre, historiser, cocher ‚ÄúRe√ßu‚Äù, WhatsApp en 2 clics.</p>
                  </div>
                </div>
              </div>
              <div class="actions">
                <button id="btnOpenOrders" class="primary" type="button">Ouvrir</button>
              </div>
            </div>

            <!-- App 2 -->
            <div class="appTile">
              <div class="top">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div class="appIcon">üí∂</div>
                  <div>
                    <h3>Caisse</h3>
                    <p>Cl√¥ture caisse ‚Ä¢ historique ‚Ä¢ impression ‚Ä¢ alertes admin</p>
                  </div>
                </div>
              </div>
              <div class="actions">
                <button id="btnOpenApp2" class="primary" type="button">Ouvrir</button>
              </div>
            </div>

            <!-- App 3 placeholder -->
            <div class="appTile">
              <div class="top">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div class="appIcon">üß©</div>
                  <div>
                    <h3>Nouvelle application</h3>
                    <p>√Ä venir : en cours....</p>
                  </div>
                </div>
              </div>
              <div class="actions">
                <button id="btnOpenApp3" class="light" type="button">Bient√¥t</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ===============================
         APP 1 : COMMANDES CLIENTS
         =============================== -->
    <div class="hidden" id="appRoot">

      <div class="appTopActions">
        <button class="backBtn" id="btnBackToHub" type="button">‚Üê Retour aux applications</button>
      </div>

      <!-- ADMIN : select boutique -->
      <div class="card hidden" id="adminCard">
        <div class="row" style="justify-content:space-between; align-items:end;">
          <div>
            <b>Mode admin</b>
            <div class="small">Choisis une boutique pour afficher ses commandes.</div>
          </div>
          <div class="row">
            <div>
              <label>Boutique</label>
              <select id="storeSelect" style="width:320px"></select>
            </div>
            <button class="light" id="btnReloadAdmin" type="button">Recharger</button>
          </div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div class="dashboard">
        <div class="statCard">
          <div>
            <div class="label"><span class="dot mec"></span> Mettre en commande</div>
            <div class="value" id="statMEC">0</div>
          </div>
          <div class="pill st st-mec">En attente</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot com"></span> Commander</div>
            <div class="value" id="statCOM">0</div>
          </div>
          <div class="pill st st-com">Command√©e</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot rup"></span> Rupture de stock</div>
            <div class="value" id="statRUP">0</div>
          </div>
          <div class="pill st st-rup">Rupture</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot recu"></span> Re√ßu (coch√©)</div>
            <div class="value" id="statRECU">0</div>
          </div>
          <div class="pill receivedTag">Re√ßu ‚úÖ</div>
        </div>
      </div>

      <!-- ADD ORDER -->
      <div class="card" id="addCard">
        <b>Ajouter une commande</b>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Client</label>
            <input id="client" placeholder="Nom client">
          </div>
          <div>
            <label>Num√©ro</label>
            <input id="tel" placeholder="06 12 34 56 78">
          </div>
          <div>
            <label>Article</label>
            <input id="article" placeholder="Article command√©">
          </div>
          <div>
            <label>Quantit√©</label>
            <input id="qty" type="number" min="1" value="1">
          </div>
          <div>
            <label>Date</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Statut</label>
            <select id="statut">
              <option>Mettre en commande</option>
              <option>Commander</option>
              <option>Rupture de stock</option>
              <option>Re√ßu partiellement</option>
            </select>
          </div>
          <div>
            <label>Vendeur</label>
            <select id="seller"></select>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Notes</label>
            <textarea id="notes" placeholder="Notes internes"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="btnAdd" class="primary" type="button">Ajouter</button>
          <button id="btnClear" class="light" type="button">Vider</button>
          <span class="small" id="msg"></span>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div>
            <b>Commandes</b>
            <div class="small">Gestion des commandes en cours et archiv√©es.</div>
          </div>
          <div class="row" style="gap:8px">
            <input id="search" placeholder="Rechercher..." style="width:220px">
            <select id="filterStatus" style="width:180px">
              <option value="">Tous statuts</option>
              <option>Mettre en commande</option>
              <option>Commander</option>
              <option>Rupture de stock</option>
              <option>Re√ßu partiellement</option>
            </select>
            <select id="antiError">
              <option value="on">Anti-erreur: ON</option>
              <option value="off">Anti-erreur: OFF</option>
            </select>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" id="tabActive">En cours (<span id="countActive">0</span>)</div>
          <div class="tab" id="tabHistory">Historique (<span id="countHistory">0</span>)</div>
          <div class="tab right">Affich√©es: <b id="countShown">0</b></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Article</th>
              <th>Statut</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div> <!-- /appRoot -->

    <!-- ====== WHATSAPP MODAL ====== -->
    <div class="modalBackdrop" id="waBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalHeader">
          <b>WhatsApp ‚Äì Pr√©parer le message</b>
          <button class="light" id="btnCloseWA" type="button">‚úñ</button>
        </div>
        <div class="modalBody">
          <div class="small" id="waMeta"></div>
          <div style="height:8px"></div>

          <label>Template</label>
          <select id="waTemplate" style="width:100%">
            <option value="arrivee">‚úÖ Arriv√©e boutique</option>
            <option value="rupture">‚ùå Rupture / d√©lai</option>
            <option value="relance">‚è≥ Relance fournisseur</option>
            <option value="partiel">üì¶ Re√ßu partiellement</option>
          </select>

          <div style="height:8px"></div>

          <label>Message</label>
          <textarea id="waText" class="waBox"></textarea>

          <div class="toggleRow">
            <input id="waNoPreview" type="checkbox">
            <span>Ouvrir directement WhatsApp sans pr√©visualisation</span>
          </div>
        </div>
        <div class="modalFooter">
          <div class="actions">
            <button class="light" id="btnCancelWA" type="button">Annuler</button>
            <button class="light" id="btnResetWA" type="button">R√©initialiser</button>
            <button class="light" id="btnCopyWA" type="button">Copier</button>
          </div>
          <div class="actions">
            <button class="primary" id="btnOpenWA" type="button">Ouvrir WhatsApp</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SETTINGS MODAL ====== -->
    <div class="modalBackdrop" id="settingsBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalHeader">
          <b>Param√®tres WhatsApp</b>
          <button class="light" id="btnCloseSettings" type="button">‚úñ</button>
        </div>
        <div class="modalBody">
          <div class="row">
            <div class="field">
              <label>Nom boutique</label>
              <input id="setShopName">
            </div>
            <div class="field">
              <label>Horaires</label>
              <input id="setHours">
            </div>
          </div>

          <div class="field" style="margin-top:10px">
            <label>Signature</label>
            <input id="setSignature">
          </div>

          <div style="height:14px"></div>
          <b style="font-size:13px;">Templates WhatsApp</b>

          <div class="grid2" style="margin-top:8px">
            <div class="field">
              <label>Arriv√©e boutique</label>
              <textarea id="tplArrivee" class="waBox"></textarea>
            </div>
            <div class="field">
              <label>Rupture</label>
              <textarea id="tplRupture" class="waBox"></textarea>
            </div>
            <div class="field">
              <label>Relance</label>
              <textarea id="tplRelance" class="waBox"></textarea>
            </div>
            <div class="field">
              <label>Re√ßu partiellement</label>
              <textarea id="tplPartiel" class="waBox"></textarea>
            </div>
          </div>
        </div>

        <div class="modalFooter">
          <div class="actions">
            <button class="light" id="btnResetSettings">R√©initialiser</button>
            <button class="primary" id="btnSaveSettings">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===============================
         APP 2 : CAISSE (UI PRO)
         =============================== -->
    <div class="hidden" id="cashRoot">

      <div class="appTopActions">
        <button class="backBtn" id="btnBackToHubFromCash">‚Üê Retour aux applications</button>
      </div>

      <!-- HEADER -->
      <div class="cashHeader">
        <div class="cashHeaderTop">
          <b>Cl√¥ture caisse</b>
          <div class="pill" id="cashShopBadge">‚Äî</div>
          <div class="pill" id="cashDateBadge">‚Äî</div>
        </div>

        <div class="cashKpis">
          <div class="cashKpi">
            <div class="label">Total compt√©</div>
            <div class="value" id="cashTotal">0,00 ‚Ç¨</div>
          </div>
          <div class="cashKpi">
            <div class="label">Fond attendu</div>
            <div class="value" id="cashExpectedLabel">0,00 ‚Ç¨</div>
          </div>
          <div class="cashKpi">
            <div class="label">√âcart</div>
            <div class="value" id="cashDiff">0,00 ‚Ç¨</div>
          </div>
        </div>
      </div>

      <!-- ADMIN SELECT -->
      <div class="card hidden" id="cashAdminCard">
        <div class="row">
          <div>
            <b>Mode admin</b>
            <div class="small">Choisir une boutique</div>
          </div>
          <select id="cashStoreSelect" style="width:280px"></select>
          <button class="light" id="btnReloadCashAdmin">Recharger</button>
        </div>
      </div>

      <!-- FORM -->
      <div class="card">
        <div class="row" style="align-items:end; justify-content:space-between;">
          <div class="row">
            <div>
              <label>Date</label>
              <input type="date" id="cashDate">
            </div>
            <div>
              <label>Chiffre du jour</label>
              <input id="cashTurnover">
            </div>
            <div>
              <label>Fond attendu</label>
              <input id="cashExpected" value="200">
            </div>
          </div>

          <div class="actions">
            <button class="light" id="btnCashPrint">Imprimer</button>
            <button class="primary" id="btnCashEmail">Ouvrir l‚Äôemail</button>
            <button class="light" id="btnCashCopyMail">Copier</button>
            <button class="light" id="btnCashReset">R√©initialiser</button>
          </div>
        </div>

        <div class="row" style="margin-top:10px; align-items:center; justify-content:space-between;">
          <div class="row" style="align-items:center;">
            <span class="pill" id="cashStatusBadge">‚Äî</span>
            <span class="small" id="cashDiffHint">‚Äî</span>
          </div>
          <span class="cashReadOnlyHint" id="cashAdminLockHint"></span>
        </div>
      </div>

      <!-- GRID 2 COLONNES -->
      <div class="cashGridMain">

        <!-- GAUCHE : COMPTAGE -->
        <div class="card cashCompact">
          <b>Comptage esp√®ces</b>
          <div class="small">Simple, rapide, lisible.</div>
          <table>
            <thead>
              <tr>
                <th>Valeur</th>
                <th style="width:120px">Qt√©</th>
                <th>Sous-total</th>
              </tr>
            </thead>
            <tbody id="cashTbody"></tbody>
          </table>
        </div>

        <!-- DROITE : ETAT + EMAIL -->
        <div style="display:flex; flex-direction:column; gap:12px;">

          <div class="cashStateCard">
            <div class="cashStateTop">
              <div>
                <b style="font-size:15px;">√âtat de caisse</b>
                <div class="small" style="color: rgba(255,255,255,.85); margin-top:4px;">R√©sum√© instantan√©.</div>
              </div>
              <div class="cashBigBadge" id="cashBigBadge">‚Äî</div>
            </div>

            <div class="cashStateNumbers">
              <div class="cashNum">
                <div class="label">Total compt√©</div>
                <div class="value" id="cashTotal2">0,00 ‚Ç¨</div>
              </div>
              <div class="cashNum">
                <div class="label">Fond attendu</div>
                <div class="value" id="cashExpected2">0,00 ‚Ç¨</div>
              </div>
              <div class="cashNum">
                <div class="label">√âcart</div>
                <div class="value" id="cashDiff2">0,00 ‚Ç¨</div>
              </div>
            </div>
          </div>

          <div class="card cashEmailCard">
            <div class="row" style="align-items:center; justify-content:space-between;">
              <div>
                <b>Email ‚Äì aper√ßu avant envoi</b>
                <div class="small">Admin : lecture seule (copie possible).</div>
              </div>
            </div>
            <div style="height:10px"></div>
            <textarea id="cashMailPreview" readonly></textarea>
          </div>

        </div>
      </div>

      <!-- ALERTES ADMIN -->

      <div class="card hidden" id="cashAdminAlertsCard">
        <div class="row">
          <b>Alertes du jour</b>
          <button class="light" id="btnCashAlertsReload">Recharger</button>
        </div>
        <div class="small" id="cashAlertsHint">‚Äî</div>
        <table>
          <thead>
            <tr>
              <th>Boutique</th>
              <th>Date</th>
              <th>Fond</th>
              <th>Total</th>
              <th>√âcart</th>
              <th>√âtat</th>
            </tr>
          </thead>
          <tbody id="cashAlertsTbody"></tbody>
        </table>
      </div>

    </div> <!-- /cashRoot -->
    <!-- Supabase v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script nomodule>
      document.body.innerHTML = `
        <div style="padding:24px;font-family:Inter,Arial,sans-serif;color:#10211b;">
          <h2>Votre navigateur est trop ancien</h2>
          <p>Cette page utilise des fonctionnalit√©s modernes (async/await). Merci de mettre √† jour votre navigateur.</p>
        </div>
      `;
    </script>

    <script type="module">
    (async function(){
      // =========================
      // Helpers
      // =========================
      const $ = (id)=>document.getElementById(id);
      const show = (el, yes)=> el && el.classList.toggle("hidden", !yes);

      const setAuthMsg = (t)=> { const el=$("authMsg"); if(el) el.textContent = t || ""; };
      const setResetMsg = (t)=> { const el=$("resetMsg"); if(el) el.textContent = t || ""; };
      const setMsg = (t)=> { const el=$("msg"); if(el) el.textContent = t || ""; };

      const setDebug = (t)=> {
        const el = $("debug");
        if (el) el.textContent = t || "";
      };

      function setAuthAlert(message){
        const box = $("authAlert");
        if(!box) return;
        box.textContent = message || "";
        box.classList.toggle("show", Boolean(message));
      }

      function setLoginLoading(isLoading){
        const btn = $("btnLogin");
        if(!btn) return;
        btn.disabled = Boolean(isLoading);
        btn.textContent = isLoading ? "Connexion‚Ä¶" : "Se connecter";
      }

      function escapeHtml(s) {
        return (s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;");
      }

      function isRecoveryFlow(){
        const h=(location.hash||"").toLowerCase();
        const q=(location.search||"").toLowerCase();
        return h.includes("access_token=") || q.includes("type=recovery") || q.includes("recovery");
      }

      function normalizeEmail(email){
        return (email || "").trim().toLowerCase();
      }

      function isUuid(value){
        return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(value || "");
      }

      // =========================
      // Supabase config
      // =========================
      const SUPABASE_URL = "https://lhddwfeaoxnlflqlihdg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZGR3ZmVhb3hubGZscWxpaGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTI0NjcsImV4cCI6MjA4MzE4ODQ2N30.5Po48JdTbLZhcXjyJ48Il511DpiYNPdUZq4H-HNPAa4";
      const SITE_URL = "https://vapochill-commandes.github.io/vapochill-suivi-commandes";

      async function loadSupabaseScript(src){
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(script);
        });
      }

      async function ensureSupabaseLoaded(){
        if (window.supabase?.createClient) return true;
        try{ await loadSupabaseScript("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"); }catch(e){ console.warn(e); }
        if (window.supabase?.createClient) return true;
        try{ await loadSupabaseScript("https://unpkg.com/@supabase/supabase-js@2"); }catch(e){ console.warn(e); }
        return Boolean(window.supabase?.createClient);
      }

      const supabaseReady = await ensureSupabaseLoaded();
      if(!supabaseReady){
        alert("‚ùå La librairie Supabase ne charge pas (CDN bloqu√© / r√©seau).");
        setAuthMsg("‚ùå Supabase indisponible. V√©rifie la connexion ou le bloqueur de pub.");
        return;
      }

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabaseClient = supabaseClient;

      // =========================
      // Clock
      // =========================
      function tickClock(){
        const d = new Date();
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        const el = $("clock");
        if(el) el.textContent = `${hh}:${mm}`;
      }
      setInterval(tickClock, 1000);
      tickClock();

      // =========================
      // State (global app)
      // =========================
      let isLoggingOut = false;
      let hasBooted = false;
      let allowAutoLogin = false;

      let currentView = "active";
      let role = null;         // "admin" | "shop"
      let profile = null;      // profiles row
      let myStoreId = null;
      let myStoreName = null;
      let storesCache = [];
      let ordersCache = [];
      let waPendingOrderId = null;

      function canWrite(){
        return role === "shop" || role === "admin";
      }

      // =========================
      // NAV : screens
      // =========================
      function applyTitle(sub){
        const t = $("uiTitle"); if(t) t.textContent = "Vapo'Chill ‚Äì Suivi commandes";
        const s = $("uiSub"); if(s) s.textContent = sub || "‚Äî";
      }

      function showLogin(){
        applyTitle("‚Äî");
        const userLabel = $("userLabel"); if(userLabel) userLabel.textContent = "non connect√©";

        show($("btnLogout"), false);
        show($("btnSettings"), false);

        show($("loginCard"), true);
        show($("hubRoot"), false);
        show($("appRoot"), false);
        show($("cashRoot"), false);

        show($("resetCard"), isRecoveryFlow());
        setAuthMsg("");
        setResetMsg("");
        setDebug("");
        setAuthAlert("");
        setLoginLoading(false);

        hasBooted = false;
      }

      function showHub(email){
        const userLabel = $("userLabel"); if(userLabel) userLabel.textContent = email || "connect√©";

        show($("loginCard"), false);
        show($("hubRoot"), true);
        show($("appRoot"), false);
        show($("cashRoot"), false);

        show($("btnLogout"), true);
        show($("btnSettings"), false);

        if (role === "admin") applyTitle("ADMIN ‚Äì toutes boutiques");
        else applyTitle(myStoreName || "Boutique");
      }

      function showOrdersApp(){
        show($("loginCard"), false);
        show($("hubRoot"), false);
        show($("appRoot"), true);
        show($("cashRoot"), false);

        show($("btnLogout"), true);
        show($("btnSettings"), true);
      }

      function showCashApp(){
        show($("loginCard"), false);
        show($("hubRoot"), false);
        show($("appRoot"), false);
        show($("cashRoot"), true);

        show($("btnLogout"), true);
        show($("btnSettings"), false);

        setCashReadOnlyMode();
      }

      // =========================
      // AUTH
      // =========================
      async function login(){
        try{
          setAuthMsg("");
          setAuthAlert("");

          const email = $("email")?.value?.trim() || "";
          const password = $("password")?.value?.trim() || "";
          if(!email || !password){
            setAuthAlert("‚ö†Ô∏è Mets email + mot de passe.");
            return;
          }

          setLoginLoading(true);
          allowAutoLogin = true;

          const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
          if(error){
            setAuthAlert("‚ùå " + error.message);
            return;
          }
          setAuthMsg("‚úÖ Connect√©.");
        }catch(e){
          setAuthAlert("‚ùå " + (e?.message || e));
        }finally{
          setLoginLoading(false);
        }
      }

      async function logout(){
        try{
          isLoggingOut = true;
          hasBooted = false;
          allowAutoLogin = false;

          await supabaseClient.auth.signOut({ scope: "local" });
        } catch (e) {
          console.warn("signOut error (ignored):", e);
        } finally {
          for (const k of Object.keys(localStorage)) {
            if (k.startsWith("sb-") && k.includes("auth")) localStorage.removeItem(k);
          }
          for (const k of Object.keys(sessionStorage)) {
            if (k.startsWith("sb-") && k.includes("auth")) sessionStorage.removeItem(k);
          }

          showLogin();
          setTimeout(()=>{ isLoggingOut = false; }, 800);
        }
      }

      async function updatePassword(){
        try{
          setResetMsg("");
          const pass = $("newPassword")?.value?.trim() || "";
          if(pass.length < 6){ setResetMsg("‚ö†Ô∏è Min 6 caract√®res."); return; }

          const { error } = await supabaseClient.auth.updateUser({ password: pass });
          if(error){ setResetMsg("‚ùå " + error.message); return; }
          setResetMsg("‚úÖ Mot de passe modifi√©. Reconnecte-toi.");
        }catch(e){
          setResetMsg("‚ùå " + (e?.message || e));
        }
      }

      async function sendReset(){
        try{
          setAuthMsg("");
          setAuthAlert("");

          const email = $("email")?.value?.trim() || "";
          if(!email){ setAuthAlert("‚ö†Ô∏è Mets l‚Äôemail puis clique ici."); return; }

          const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: SITE_URL + "/" });
          if(error){ setAuthAlert("‚ùå " + error.message); return; }

          setAuthMsg("‚úÖ Email de r√©initialisation envoy√©.");
        }catch(e){
          setAuthAlert("‚ùå " + (e?.message || e));
        }
      }

      async function getCurrentUserEmail(){
        const { data } = await supabaseClient.auth.getUser();
        return data?.user?.email || "";
      }

      // =========================
      // PROFILE / STORES
      // =========================
      async function fetchProfile(){
        const { data: ures, error: uerr } = await supabaseClient.auth.getUser();
        if(uerr) throw new Error(uerr.message);
        const uid = ures?.user?.id;
        if(!uid) return null;

        const { data, error } = await supabaseClient
          .from("profiles")
          .select("role, store_id, display_name")
          .eq("user_id", uid)
          .maybeSingle();

        if(error) throw new Error("profiles: " + error.message);
        if(!data) throw new Error("Profil introuvable (table profiles).");
        return data;
      }

      async function fetchStores(){
        const { data, error } = await supabaseClient
          .from("stores")
          .select("id,name,slug,email")
          .order("name");
        if(error) throw new Error("stores: " + error.message);
        storesCache = data || [];
      }

      function fillStoreSelect(){
        const sel = $("storeSelect");
        if(!sel) return;
        sel.innerHTML = storesCache.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
        if(storesCache[0]) sel.value = storesCache[0].id;
      }

      function fillCashStoreSelect(){
        const sel = $("cashStoreSelect");
        if(!sel) return;
        sel.innerHTML = storesCache.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
        // default = 1st store
        if(storesCache[0]) sel.value = storesCache[0].id;
      }

      function findStoreByEmail(email){
        const target = normalizeEmail(email);
        if (!target) return null;
        return storesCache.find(store => normalizeEmail(store.email) === target) || null;
      }

      async function ensureStoreId(email){
        if (myStoreId) return myStoreId;

        const userEmail = normalizeEmail(email || await getCurrentUserEmail());
        if (!userEmail) return null;

        if (!storesCache.length) await fetchStores();

        let matchedStore = findStoreByEmail(userEmail);
        if (!matchedStore?.id) return null;

        myStoreId = matchedStore.id;
        myStoreName = matchedStore.name || myStoreName;

        try{
          const { data } = await supabaseClient.auth.getUser();
          const uid = data?.user?.id;
          if (uid) {
            await supabaseClient
              .from("profiles")
              .update({ store_id: matchedStore.id })
              .eq("user_id", uid);
          }
        }catch(err){
          console.warn("store_id update failed:", err?.message || err);
        }

        return myStoreId;
      }

      // =========================
      // SETTINGS (WhatsApp)
      // =========================
      const USERS = ["Laetitia","Marco","Charlotte","Nico","Alan","Corentin","Mathieu","Romain"];

      const WA_PREVIEW_KEY = "wa_preview_mode_v1";
      if (!localStorage.getItem(WA_PREVIEW_KEY)) localStorage.setItem(WA_PREVIEW_KEY, "preview");

      const SETTINGS_KEY = "vc_settings_v1";

      const DEFAULT_SETTINGS = {
        shopName: "Vapo'Chill",
        hours: "",
        signature: "{vendeur} - Vapochill",
        templates: {
          arrivee:
`Bonjour,

Votre commande {article} est bien arriv√©e en boutique
Vous pouvez passer quand vous voulez

{signature}`,
          rupture:
`Bonjour,

Petit retour pour votre commande {article} : elle est en rupture chez le fournisseur.
Je vous tiens au courant d√®s que j‚Äôai une date

{signature}`,
          relance:
`Bonjour,

Je reviens vers vous : votre commande {article} est toujours en attente.
On relance le fournisseur et on vous tient inform√©

{signature}`,
          partiel:
`Bonjour,

Une partie de votre commande {article} est arriv√©e en boutique
Je vous confirme le reste d√®s r√©ception

{signature}`
        }
      };

      function loadSettings(){
        try{
          const raw = localStorage.getItem(SETTINGS_KEY);
          if (!raw) return structuredClone(DEFAULT_SETTINGS);
          const obj = JSON.parse(raw);
          return {
            ...structuredClone(DEFAULT_SETTINGS),
            ...obj,
            templates: { ...structuredClone(DEFAULT_SETTINGS.templates), ...(obj.templates || {}) }
          };
        }catch{
          return structuredClone(DEFAULT_SETTINGS);
        }
      }

      function saveSettingsToStorage(settings){
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }

      function applySettingsToUI(){
        const s = loadSettings();
        const name = (myStoreName || s.shopName || "Vapo'Chill");
        const t = $("uiTitle"); if(t) t.textContent = `${name} ‚Äì Suivi commandes`;
      }

      function getWAPreviewMode(){
        return localStorage.getItem(WA_PREVIEW_KEY) || "preview";
      }
      function setWAPreviewMode(mode){
        localStorage.setItem(WA_PREVIEW_KEY, mode);
      }

      function templateToMessage(template, order){
        const s = loadSettings();
        const shop = myStoreName || s.shopName || "Vapo'Chill";
        const hours = s.hours || "";
        const vendeur = ($("seller")?.value || "").trim();

        const signature = (s.signature || "{vendeur} - Vapochill")
          .replaceAll("{vendeur}", vendeur)
          .replaceAll("{boutique}", shop)
          .replaceAll("{horaires}", hours);

        return (template || "")
          .replaceAll("{article}", order.article || "votre commande")
          .replaceAll("{client}", order.client || "")
          .replaceAll("{vendeur}", vendeur)
          .replaceAll("{boutique}", shop)
          .replaceAll("{horaires}", hours)
          .replaceAll("{signature}", signature);
      }

      function getTemplateByKey(key){
        const s = loadSettings();
        const t = s.templates || {};
        return t[key] || "";
      }

      function phoneToWhatsAppNumber(phone) {
        let p = (phone || "").replace(/[^\d+]/g, "");
        p = p.replace(/\D/g, "");
        if (!p) return "";
        if (p.startsWith("0") && p.length === 10) return "33" + p.slice(1);
        if (p.startsWith("33")) return p;
        if (p.startsWith("0033")) return "33" + p.slice(4);
        return p;
      }

      function openWhatsAppWithText(order, customText) {
        const num = phoneToWhatsAppNumber(order.tel);
        if (!num) { alert("‚ö†Ô∏è Num√©ro invalide pour WhatsApp."); return; }
        const text = encodeURIComponent(customText || "");
        const url = `https://wa.me/${num}?text=${text}`;
        window.open(url, "_blank");
      }

      function openSettings(){
        const s = loadSettings();
        $("setShopName").value = s.shopName || "";
        $("setHours").value = s.hours || "";
        $("setSignature").value = s.signature || "";

        $("tplArrivee").value = s.templates.arrivee || "";
        $("tplRupture").value = s.templates.rupture || "";
        $("tplRelance").value = s.templates.relance || "";
        $("tplPartiel").value = s.templates.partiel || "";

        $("settingsBackdrop").style.display = "flex";
      }

      function closeSettings(){
        $("settingsBackdrop").style.display = "none";
      }

      function resetSettingsDefaults(){
        if (!confirm("R√©initialiser tous les param√®tres et templates WhatsApp ?")) return;
        saveSettingsToStorage(structuredClone(DEFAULT_SETTINGS));
        openSettings();
        applySettingsToUI();
      }

      function saveSettings(){
        const s = loadSettings();
        s.shopName = $("setShopName").value.trim() || DEFAULT_SETTINGS.shopName;
        s.hours = $("setHours").value.trim();
        s.signature = $("setSignature").value.trim() || DEFAULT_SETTINGS.signature;

        s.templates.arrivee = $("tplArrivee").value;
        s.templates.rupture = $("tplRupture").value;
        s.templates.relance = $("tplRelance").value;
        s.templates.partiel = $("tplPartiel").value;

        saveSettingsToStorage(s);
        applySettingsToUI();
        alert("‚úÖ Param√®tres enregistr√©s.");
        closeSettings();
      }

      // =========================
      // APP 1 : Orders
      // =========================
      function statusClass(statut) {
        if (statut === "Mettre en commande") return "st st-mec";
        if (statut === "Commander") return "st st-com";
        if (statut === "Rupture de stock") return "st st-rup";
        if (statut === "Re√ßu partiellement") return "st st-par";
        return "st";
      }

      function setTodayDefault() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("date").value = `${yyyy}-${mm}-${dd}`;
      }

      function timeSince(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        let diff = Math.max(0, Date.now() - d.getTime());
        const min = Math.floor(diff / 60000);
        const h = Math.floor(min / 60);
        const m = min % 60;
        const j = Math.floor(h / 24);
        const hh = h % 24;
        if (j > 0) return `il y a ${j}j ${hh}h`;
        if (h > 0) return `il y a ${h}h ${m}m`;
        return `il y a ${m}m`;
      }

      function antiErrorOn(){
        return $("antiError")?.value === "on";
      }

      function getActiveAndHistory(list){
        const active = [];
        const history = [];
        for(const o of list){
          if(o.picked_up_at) history.push(o);
          else active.push(o);
        }
        return { active, history };
      }

      async function loadOrders(){
        setDebug("");
        setMsg("");

        let storeId = myStoreId;
        if (role === "admin") {
          storeId = $("storeSelect")?.value || "";
        }

        let query = supabaseClient
          .from("orders")
          .select("*")
          .order("created_at", { ascending: false });

        if (storeId) query = query.eq("store_id", storeId);

        const { data, error } = await query;
        if (error) { setDebug("orders: " + error.message); return; }

        ordersCache = data || [];
        renderOrders();
      }

      function updateDashboard(activeList){
        let mec=0, com=0, rup=0, recu=0;
        for (const o of activeList){
          if (o.statut === "Mettre en commande") mec++;
          if (o.statut === "Commander") com++;
          if (o.statut === "Rupture de stock") rup++;
          if (Boolean(o.received_checked)) recu++;
        }
        $("statMEC").textContent = mec;
        $("statCOM").textContent = com;
        $("statRUP").textContent = rup;
        $("statRECU").textContent = recu;
      }

      function renderOrders(){
        const { active, history } = getActiveAndHistory(ordersCache);

        $("countActive").textContent = active.length;
        $("countHistory").textContent = history.length;
        updateDashboard(active);

        const q = ($("search").value || "").trim().toLowerCase();
        const filterStatus = $("filterStatus").value;

        const base = (currentView === "history") ? history : active;

        let list = base.filter(o=>{
          if(filterStatus && o.statut !== filterStatus) return false;
          if(!q) return true;
          return (
            (o.client || "").toLowerCase().includes(q) ||
            (o.tel || "").toLowerCase().includes(q) ||
            (o.article || "").toLowerCase().includes(q) ||
            (o.notes || "").toLowerCase().includes(q)
          );
        });

        if(currentView === "active"){
          list = [...list].sort((a,b) => (Boolean(b.received_checked) - Boolean(a.received_checked)));
        }

        $("countShown").textContent = list.length;

        const tbody = $("tbody");
        tbody.innerHTML = "";

        for(const o of list){
          const tr = document.createElement("tr");
          if(currentView === "active" && Boolean(o.received_checked)) tr.classList.add("row-received");

          const since = timeSince(o.created_at || o.createdAt);
          const receivedPill = (currentView === "active" && Boolean(o.received_checked))
            ? `<span class="pill receivedTag">RE√áU ‚úÖ</span>` : "";

          const receivedControl = (currentView === "active" && role === "shop")
            ? `<label class="cb"><input type="checkbox" ${Boolean(o.received_checked) ? "checked":""} data-action="received" data-id="${o.id}"> Re√ßu</label>`
            : `<span class="small">‚Äî</span>`;

          const actionsShop = (currentView === "active")
            ? `
              <div class="actions">
                ${receivedControl}
                <button class="ok" data-action="picked" data-id="${o.id}">Commande r√©cup√©r√©e</button>
                <button class="danger" data-action="delete" data-id="${o.id}">Supprimer</button>
              </div>
            `
            : `
              <div class="actions">
                <button class="danger" data-action="delete" data-id="${o.id}">Supprimer</button>
              </div>
            `;

          const actionsAdmin = `<div class="small">Lecture</div>`;

          tr.innerHTML = `
            <td>
              <span class="pill">${escapeHtml(o.date || "")}</span><br/>
              <span class="small">${escapeHtml(since)}</span><br/>
              ${receivedPill}
            </td>

            <td>
              <b>${escapeHtml(o.client || "")}</b><br/>
              <span class="small">${escapeHtml(o.tel || "")}</span><br/>
              <div class="small">Cr√©√©e par: <b>${escapeHtml(o.seller || "-")}</b></div>
            </td>

            <td>
              ${escapeHtml(o.article || "")}<br/>
              <span class="small">Qt√©: ${Number(o.qty || 1)} ‚Ä¢ Vendeur: ${escapeHtml(o.seller || "-")}</span>
            </td>

            <td>
              <span class="pill ${statusClass(o.statut)}">${escapeHtml(o.statut || "")}</span>
              <div style="margin-top:6px">
                <select ${role !== "shop" ? "disabled" : ""} data-action="status" data-id="${o.id}">
                  ${["Mettre en commande","Commander","Rupture de stock","Re√ßu partiellement"].map(s => `
                    <option ${o.statut===s ? "selected":""}>${escapeHtml(s)}</option>
                  `).join("")}
                </select>
              </div>
            </td>

            <td>${escapeHtml(o.notes || "")}</td>

            <td>${role === "shop" ? actionsShop : actionsAdmin}</td>
          `;

          tbody.appendChild(tr);
        }
      }

      function initUsers(){
        $("seller").innerHTML = USERS.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("");
        $("seller").value = USERS[0];
      }

      function resetForm(){
        $("client").value = "";
        $("tel").value = "";
        $("article").value = "";
        $("qty").value = 1;
        $("notes").value = "";
        $("statut").value = "Mettre en commande";
        setTodayDefault();
        setMsg("");
      }

      async function addOrder(){
        let storeId = myStoreId;

        if (role === "admin") {
          storeId = $("storeSelect")?.value || "";
          if (!storeId) { alert("‚ö†Ô∏è Admin : s√©lectionne une boutique."); return; }
        }

        if (!storeId) {
          const email = await getCurrentUserEmail();
          await ensureStoreId(email);
          storeId = myStoreId;
        }

        if (!storeId) {
          const email = await getCurrentUserEmail();
          alert(`‚ö†Ô∏è Boutique inconnue (storeId manquant).\nEmail connect√©: ${email || "inconnu"}`);
          return;
        }

        const client = $("client").value.trim();
        const tel = $("tel").value.trim();
        const article = $("article").value.trim();
        const qty = Number($("qty").value || 1);
        const date = $("date").value;
        const statut = $("statut").value;
        const notes = $("notes").value.trim();
        const seller = $("seller").value;

        if (!client || !tel || !article) { setMsg("‚ö†Ô∏è Client, Num√©ro et Article obligatoires."); return; }
        if (qty <= 0) { setMsg("‚ö†Ô∏è Qt√© minimum = 1."); return; }

        setMsg("‚è≥ Ajout‚Ä¶");

        const payload = {
          store_id: storeId,
          client, tel, article, qty, date, statut, notes,
          seller,
          received_checked: false,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabaseClient.from("orders").insert([payload]);
        if(error){
          setMsg("‚ùå " + error.message);
          alert("‚ùå Impossible d'ajouter : " + error.message);
          return;
        }

        setMsg("‚úÖ Ajout√©e.");
        resetForm();
        await loadOrders();
      }

      async function updateStatus(id, newStatus){
        if (!canWrite()) return;

        const seller = $("seller").value;
        const audit = { updated_at: new Date().toISOString() };
        if (isUuid(seller)) audit.updated_by = seller;

        const { error } = await supabaseClient
          .from("orders")
          .update({ statut: newStatus, ...audit })
          .eq("id", id);

        if(error){ alert("‚ùå " + error.message); return; }
        await loadOrders();
      }

      async function toggleReceived(id){
        if (!canWrite()) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if(!o) return;

        const newVal = !Boolean(o.received_checked);
        const seller = $("seller").value;
        const audit = { updated_at: new Date().toISOString() };
        if (isUuid(seller)) audit.updated_by = seller;

        const { error } = await supabaseClient
          .from("orders")
          .update({ received_checked: newVal, ...audit })
          .eq("id", id);

        if(error){ alert("‚ùå " + error.message); return; }

        await loadOrders();

        const updated = ordersCache.find(x => String(x.id) === String(id));
        if(updated && updated.received_checked){
          if (getWAPreviewMode() === "direct") {
            const msg = templateToMessage(getTemplateByKey("arrivee"), updated);
            openWhatsAppWithText(updated, msg);
          } else {
            showWAModal(updated);
          }
        }
      }

      function confirmDanger(msg){
        return confirm("‚ö†Ô∏è " + msg);
      }

      async function markPickedUp(id){
        if (!canWrite()) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if(!o) return;

        if (antiErrorOn() && !Boolean(o.received_checked)) {
          alert("‚ö†Ô∏è Coche d‚Äôabord la case ‚ÄúRe√ßu‚Äù.");
          return;
        }

        if (!confirmDanger("Confirmer : commande r√©cup√©r√©e / termin√©e ?")) return;

        const seller = $("seller").value;
        const audit = { updated_at: new Date().toISOString() };
        if (isUuid(seller)) audit.updated_by = seller;
        const pickedBy = isUuid(seller) ? { picked_up_by: seller } : {};

        const { error } = await supabaseClient
          .from("orders")
          .update({
            picked_up_at: new Date().toISOString(),
            ...pickedBy,
            ...audit
          })
          .eq("id", id);

        if(error){ alert("‚ùå " + error.message); return; }
        await loadOrders();
      }

      async function deleteOrder(id){
        if (!canWrite()) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if(!o) return;

        if (antiErrorOn() && currentView === "active" && !Boolean(o.received_checked)) {
          alert("‚ö†Ô∏è Anti-erreur : impossible de supprimer tant que ‚ÄúRe√ßu‚Äù n‚Äôest pas coch√©.\n(Si tu veux vraiment, mets Anti-erreur sur OFF.)");
          return;
        }

        if (!confirmDanger("Supprimer d√©finitivement ?")) return;

        const { error } = await supabaseClient.from("orders").delete().eq("id", id);
        if(error){ alert("‚ùå " + error.message); return; }
        await loadOrders();
      }

      // =========================
      // WhatsApp modal
      // =========================
      function showWAModal(order){
        waPendingOrderId = order.id;

        $("waMeta").textContent = `Client: ${order.client || "-"} ‚Ä¢ Tel: ${order.tel || "-"} ‚Ä¢ Article: ${order.article || "-"}`;

        $("waTemplate").value = "arrivee";
        $("waText").value = templateToMessage(getTemplateByKey("arrivee"), order);

        $("waNoPreview").checked = (getWAPreviewMode() === "direct");
        $("waBackdrop").style.display = "flex";
      }

      function closeWAModal(){
        if ($("waNoPreview")?.checked) setWAPreviewMode("direct");
        else setWAPreviewMode("preview");

        $("waBackdrop").style.display = "none";
        waPendingOrderId = null;
      }

      function applySelectedTemplate(){
        const id = waPendingOrderId;
        if (!id) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if (!o) return;

        const key = $("waTemplate").value;
        $("waText").value = templateToMessage(getTemplateByKey(key), o);
      }

      async function copyWAText(){
        const val = $("waText").value || "";
        try{
          await navigator.clipboard.writeText(val);
          alert("‚úÖ Message copi√©.");
        }catch{
          $("waText").select();
          document.execCommand("copy");
          alert("‚úÖ Message copi√©.");
        }
      }

      function confirmOpenWhatsApp(){
        const id = waPendingOrderId;
        if (!id) return closeWAModal();

        const o = ordersCache.find(x => String(x.id) === String(id));
        if (!o) return closeWAModal();

        openWhatsAppWithText(o, $("waText").value);
        closeWAModal();
      }

      // =========================
      // HUB actions (App 1)
      // =========================
      async function openOrdersFromHub(){
        showOrdersApp();

        if(role === "admin"){
          show($("adminCard"), true);
          show($("addCard"), false);
          await loadOrders();
        } else {
          show($("adminCard"), false);
          show($("addCard"), true);
          await loadOrders();
        }
      }

      function backToHub(){
        showHub($("userLabel").textContent);
      }

      // =========================
      // APP 2 : CAISSE (Supabase)
      // Table: cash_closings
      // =========================
      const CASH_DENOMS = [0.01,0.02,0.05,0.10,0.20,0.50,1,2,5,10,20,50,100];
      const CASH_TO = ["romain.thierry@vapochill.fr","dthierry@impressiondt.fr"];
      let cashBuilt = false;

      function fmtEUR(n){
        const x = Number(n || 0);
        return x.toLocaleString("fr-FR", { style:"currency", currency:"EUR" });
      }
      function parseNum(v){
        if (v === null || v === undefined) return 0;
        const s = String(v).replace(",", ".").replace(/[^0-9.\-]/g, "");
        const n = Number(s);
        return Number.isFinite(n) ? n : 0;
      }
      function datePrettyFR(yyyyMMdd){
        const m = String(yyyyMMdd || "").match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if(!m) return yyyyMMdd || "";
        return `${m[3]}/${m[2]}/${m[1]}`;
      }

      function buildCashTableOnce(){
        if (cashBuilt) return;
        cashBuilt = true;

        const tb = $("cashTbody");
        tb.innerHTML = "";

        for (const denom of CASH_DENOMS){
          const key = String(denom).replace(".","_");
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td><span class="cashDenomPill">${denom.toLocaleString("fr-FR")} ‚Ç¨</span></td>
            <td><input type="number" min="0" step="1" value="0" data-denom="${denom}" class="cashQty" /></td>
            <td id="cashSub_${key}" class="cashSubSmall">0,00 ‚Ç¨</td>
          `;
          tb.appendChild(tr);
        }
      }

      function setTodayDefaultCash(){
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("cashDate").value = `${yyyy}-${mm}-${dd}`;
      }

      function getCashTargetStoreId(){
        if (role === "admin") return $("cashStoreSelect")?.value || "";
        return myStoreId || "";
      }
      function getCashTargetStoreName(){
        if (role === "admin") {
          const id = $("cashStoreSelect")?.value || "";
          return storesCache.find(s=>s.id===id)?.name || "Boutique";
        }
        return myStoreName || "Boutique";
      }

      function updateCashHeaderBadges(){
        if($("cashShopBadge")) $("cashShopBadge").textContent = getCashTargetStoreName();
        if($("cashDateBadge")) $("cashDateBadge").textContent = datePrettyFR($("cashDate")?.value || "");
      }



      function setCashReadOnlyMode(){
        const isAdmin = (role === "admin");

        // Admin: lecture seule (pas de modifications)
        [$("cashTurnover"), $("cashExpected"), $("btnCashReset")].filter(Boolean).forEach(el=>{ el.disabled = isAdmin; });
        document.querySelectorAll(".cashQty").forEach(inp=>{ inp.disabled = isAdmin; });

        const lock = $("cashAdminLockHint");
        if(lock) lock.textContent = isAdmin ? "üîí Admin : lecture seule (copie possible, pas de modification)." : "";
      }

      async function loadCashRow(storeId, date){
        const { data, error } = await supabaseClient
          .from("cash_closings")
          .select("*")
          .eq("store_id", storeId)
          .eq("date", date)
          .maybeSingle();
        if(error) throw new Error(error.message);
        return data || null;
      }

      async function upsertCashRow(payload){
        const { error } = await supabaseClient
          .from("cash_closings")
          .upsert(payload, { onConflict: "store_id,date" });
        if(error) throw new Error(error.message);
      }

      async function deleteCashHistorySupabase(storeId, fromDate){
        const { error } = await supabaseClient
          .from("cash_closings")
          .delete()
          .eq("store_id", storeId)
          .gte("date", fromDate);
        if(error) throw new Error(error.message);
      }

      function applyCashData(row){
        if(!row) return;
        $("cashTurnover").value = (row.turnover ?? "");
        $("cashExpected").value = (row.expected ?? "");

        const qty = row.denoms || {};
        document.querySelectorAll(".cashQty").forEach(inp=>{
          const denom = inp.dataset.denom;
          const v = qty?.[denom];
          inp.value = Number.isFinite(v) ? v : (parseInt(v || "0",10) || 0);
        });
      }

      function updateCashMailPreview(total, expected, diff){
        const date = $("cashDate").value;
        const dateTxt = datePrettyFR(date);
        const ca = parseNum($("cashTurnover").value);
        const shop = getCashTargetStoreName();

        const diffLine =
          diff === 0
            ? `Erreur caisse : 0 ‚Ç¨ (caisse OK ‚úÖ)`
            : (diff > 0
                ? `Erreur caisse : +${fmtEUR(diff)} (trop en caisse üü¢)`
                : `Erreur caisse : ${fmtEUR(diff)} (manque en caisse üî¥)`
              );

        const body =
`Bonjour,

Nous terminons la journ√©e du ${dateTxt}
avec un chiffre du jour de ${fmtEUR(ca)}.

Fond de caisse attendu : ${fmtEUR(expected)}
Total compt√© : ${fmtEUR(total)}

${diffLine}

Bonne soir√©e √† vous,
${shop}`;

        $("cashMailPreview").value = body;
      }

      function setCashStatus(diffRounded){
        const badge = $("cashStatusBadge");
        const hint = $("cashDiffHint");

        if (diffRounded === 0){
          badge.className = "pill badgeOk";
          badge.textContent = "‚úÖ Caisse OK";
          hint.textContent = "0 = caisse OK";
        } else {
          badge.className = "pill badgeErr";
          badge.textContent = (diffRounded > 0) ? "üü¢ Trop en caisse" : "üî¥ Manque en caisse";
          hint.textContent = (diffRounded > 0) ? `+${fmtEUR(diffRounded)} = trop` : `${fmtEUR(diffRounded)} = manque`;
        }

        const big = $("cashBigBadge");
        if(big){ big.textContent = (diffRounded === 0) ? "‚úÖ OK" : "‚ùå √âCART"; }
      }

      function computeCashLocalOnly(){
        let total = 0;

        document.querySelectorAll(".cashQty").forEach(inp=>{
          const denom = parseNum(inp.dataset.denom);
          const qty = parseInt(inp.value || "0", 10) || 0;
          const sub = denom * qty;
          total += sub;

          const subId = `cashSub_${String(denom).replace(".","_")}`;
          const td = $(subId);
          if (td) td.textContent = fmtEUR(sub);
        });

        const expected = parseNum($("cashExpected").value);
        const diff = total - expected;
        const diffRounded = Math.round(diff * 100) / 100;

        $("cashTotal").textContent = fmtEUR(total);
        $("cashExpectedLabel").textContent = fmtEUR(expected);
        $("cashDiff").textContent = fmtEUR(diffRounded);

        // secondaires (carte √©tat)
        if($("cashTotal2")) $("cashTotal2").textContent = fmtEUR(total);
        if($("cashExpected2")) $("cashExpected2").textContent = fmtEUR(expected);
        if($("cashDiff2")) $("cashDiff2").textContent = fmtEUR(diffRounded);


        setCashStatus(diffRounded);
        updateCashMailPreview(total, expected, diffRounded);

        updateCashHeaderBadges();

        return { total, expected, diffRounded };
      }

      async function saveCashToSupabase(){
        if (role === "admin") return; // admin: lecture seule

        const storeId = getCashTargetStoreId();
        const date = $("cashDate").value;
        if(!storeId || !date) return;

        const qty = {};
        document.querySelectorAll(".cashQty").forEach(inp=>{
          const denom = inp.dataset.denom;
          qty[denom] = parseInt(inp.value || "0", 10) || 0;
        });

        const { total, expected, diffRounded } = computeCashLocalOnly();

        const payload = {
          store_id: storeId,
          date,
          turnover: parseNum($("cashTurnover").value),
          expected,
          total: Math.round(total * 100) / 100,
          diff: diffRounded,
          denoms: qty,
          updated_at: new Date().toISOString()
        };

        try{
          await upsertCashRow(payload);
        }catch(err){
          console.warn("saveCashToSupabase:", err?.message || err);
        }
      }

      async function loadCashForCurrentTarget(){
        setCashReadOnlyMode();
        const storeId = getCashTargetStoreId();
        const date = $("cashDate").value;

        updateCashHeaderBadges();

        if(!storeId){
          resetCashInputs(false);
          computeCashLocalOnly();          if(role==="admin") await loadCashAlertsAdmin();
          return;
        }

        try{
          const row = await loadCashRow(storeId, date);
          if(row) applyCashData(row);
          else resetCashInputs(false);

          computeCashLocalOnly();          if(role==="admin") await loadCashAlertsAdmin();
        }catch(err){
          console.warn("loadCashForCurrentTarget:", err?.message || err);
          resetCashInputs(false);
          computeCashLocalOnly();          if(role==="admin") await loadCashAlertsAdmin();
        }
      }

      function resetCashInputs(confirmBox=true){
        if(confirmBox && !confirm("R√©initialiser le comptage ?")) return;
        $("cashTurnover").value = "";
        if (!$("cashExpected").value) $("cashExpected").value = "200";
        document.querySelectorAll(".cashQty").forEach(inp=> inp.value = 0);
        computeCashLocalOnly();
        saveCashToSupabase();
      }

      function openCashMail(){
        const date = $("cashDate").value;
        const shop = getCashTargetStoreName();
        const subject = `Cl√¥ture caisse ‚Äì ${shop} ‚Äì ${datePrettyFR(date)}`;
        const body = $("cashMailPreview").value || "";

        const to = CASH_TO.join(",");
        const mailto =
          `mailto:${encodeURIComponent(to)}` +
          `?subject=${encodeURIComponent(subject)}` +
          `&body=${encodeURIComponent(body)}`;

        window.location.href = mailto;
      }

      function printCash(){
        window.print();
      }

      async function loadCashHistory(){
        const storeId = getCashTargetStoreId();
        if(!storeId) return;

        const days = Number($("cashHistoryRange")?.value || 30);
        const fromDate = new Date(Date.now() - days*86400000).toISOString().slice(0,10);

        const { data, error } = await supabaseClient
          .from("cash_closings")
          .select("date,expected,total,diff,updated_at")
          .eq("store_id", storeId)
          .gte("date", fromDate)
          .order("date", { ascending:false });

        const tbody = $("cashHistoryTbody");
        tbody.innerHTML = "";

        if(error){
          $("cashHistoryHint").textContent = "Erreur chargement historique.";
          return;
        }

        if(!data || !data.length){
          $("cashHistoryHint").textContent = "Aucune cl√¥ture sur la p√©riode.";
          return;
        }

        $("cashHistoryHint").textContent = `${data.length} cl√¥ture(s) trouv√©e(s).`;

        for(const r of data){
          const diff = Number(r.diff || 0);
          const ok = (Math.round(diff*100)/100) === 0;

          const tr = document.createElement("tr");
          if(!ok) tr.classList.add("rowErr");

          tr.innerHTML = `
            <td><span class="pill">${datePrettyFR(r.date)}</span></td>
            <td>${fmtEUR(r.expected)}</td>
            <td>${fmtEUR(r.total)}</td>
            <td><b>${fmtEUR(diff)}</b></td>
            <td>
              <span class="pill ${ok ? "badgeOk" : "badgeErr"}">
                ${ok ? "‚úÖ OK" : "‚ö†Ô∏è Erreur"}
              </span>
            </td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function deleteCashHistory(){
        if(!confirm("Supprimer l‚Äôhistorique sur la p√©riode s√©lectionn√©e ?")) return;

        const storeId = getCashTargetStoreId();
        if(!storeId) return;

        const days = Number($("cashHistoryRange")?.value || 30);
        const fromDate = new Date(Date.now() - days*86400000).toISOString().slice(0,10);

        try{
          await deleteCashHistorySupabase(storeId, fromDate);        }catch(err){
          alert("Erreur suppression historique: " + (err?.message || err));
        }
      }

      async function loadCashAlertsAdmin(){
        if(role !== "admin") return;

        const today = new Date().toISOString().slice(0,10);

        const { data, error } = await supabaseClient
          .from("cash_closings")
          .select("store_id,date,expected,total,diff")
          .eq("date", today)
          .neq("diff", 0);

        const tbody = $("cashAlertsTbody");
        tbody.innerHTML = "";

        if(error || !data || !data.length){
          $("cashAlertsHint").textContent = "Aucune alerte aujourd‚Äôhui.";
          return;
        }

        $("cashAlertsHint").textContent = `${data.length} boutique(s) en alerte aujourd‚Äôhui.`;

        for(const r of data){
          const name = storesCache.find(s=>s.id===r.store_id)?.name || r.store_id;

          const tr = document.createElement("tr");
          tr.classList.add("rowErr");

          tr.innerHTML = `
            <td><b>${escapeHtml(name)}</b></td>
            <td>${datePrettyFR(r.date)}</td>
            <td>${fmtEUR(r.expected)}</td>
            <td>${fmtEUR(r.total)}</td>
            <td><b>${fmtEUR(r.diff)}</b></td>
            <td><span class="pill badgeErr">${r.diff > 0 ? "TROP" : "MANQUE"}</span></td>
          `;
          tbody.appendChild(tr);
        }
      }

      async function openCashFromHub(){
        showCashApp();

        buildCashTableOnce();
        if (!$("cashDate").value) setTodayDefaultCash();

        // badges
        updateCashHeaderBadges();

        // admin UI
        if(role === "admin"){
          show($("cashAdminCard"), true);
          show($("cashAdminAlertsCard"), true);
          fillCashStoreSelect();
          await loadCashAlertsAdmin();
        } else {
          show($("cashAdminCard"), false);
          show($("cashAdminAlertsCard"), false);
        }

        await loadCashForCurrentTarget();
      }

      // =========================
      // Enter after login
      // =========================
      async function enterAfterLogin(email){
        initUsers();
        setTodayDefault();
        resetForm();

        profile = await fetchProfile();
        role = profile.role || "shop";
        myStoreId = profile.store_id || null;

        await fetchStores();

        if(role === "admin"){
          myStoreName = "Admin";
          fillStoreSelect();
          fillCashStoreSelect();
        } else {
          if(!myStoreId) await ensureStoreId(email);
          if(!myStoreId) throw new Error("Ton profil n‚Äôa pas de store_id et aucun store ne correspond √† ton email.");
          const s = storesCache.find(x => x.id === myStoreId);
          myStoreName = s?.name || "Boutique";
        }

        applySettingsToUI();
        showHub(email);
      }

      // =========================
      // Events (global)
      // =========================
      $("btnLogin")?.addEventListener("click", login);
      $("btnLogout")?.addEventListener("click", logout);
      $("btnReset")?.addEventListener("click", sendReset);
      $("btnUpdatePass")?.addEventListener("click", updatePassword);

      $("btnSettings")?.addEventListener("click", openSettings);
      $("btnCloseSettings")?.addEventListener("click", closeSettings);
      $("btnResetSettings")?.addEventListener("click", resetSettingsDefaults);
      $("btnSaveSettings")?.addEventListener("click", saveSettings);

      $("btnCloseWA")?.addEventListener("click", closeWAModal);
      $("btnCancelWA")?.addEventListener("click", closeWAModal);
      $("btnResetWA")?.addEventListener("click", applySelectedTemplate);
      $("btnCopyWA")?.addEventListener("click", copyWAText);
      $("btnOpenWA")?.addEventListener("click", confirmOpenWhatsApp);
      $("waTemplate")?.addEventListener("change", applySelectedTemplate);

      $("waBackdrop")?.addEventListener("click", closeWAModal);
      $("settingsBackdrop")?.addEventListener("click", closeSettings);

      $("btnOpenOrders")?.addEventListener("click", openOrdersFromHub);
      $("btnBackToHub")?.addEventListener("click", backToHub);

      $("btnOpenApp2")?.addEventListener("click", openCashFromHub);
      $("btnBackToHubFromCash")?.addEventListener("click", backToHub);

      $("btnOpenApp3")?.addEventListener("click", ()=> alert("üß© App 3 bient√¥t !"));

      // Orders app events
      $("btnAdd")?.addEventListener("click", addOrder);
      $("btnClear")?.addEventListener("click", resetForm);

      $("tabActive")?.addEventListener("click", ()=>{
        currentView="active";
        $("tabActive").classList.add("active");
        $("tabHistory").classList.remove("active");
        renderOrders();
      });
      $("tabHistory")?.addEventListener("click", ()=>{
        currentView="history";
        $("tabHistory").classList.add("active");
        $("tabActive").classList.remove("active");
        renderOrders();
      });

      $("search")?.addEventListener("input", renderOrders);
      $("filterStatus")?.addEventListener("change", renderOrders);

      $("btnReloadAdmin")?.addEventListener("click", loadOrders);
      $("storeSelect")?.addEventListener("change", loadOrders);

      $("tbody")?.addEventListener("change", async (e)=>{
        const el = e.target;
        const action = el?.dataset?.action;
        const id = el?.dataset?.id;
        if(action === "status"){
          await updateStatus(id, el.value);
        }
        if(action === "received"){
          await toggleReceived(id);
        }
      });

      $("tbody")?.addEventListener("click", async (e)=>{
        const el = e.target;
        const action = el?.dataset?.action;
        const id = el?.dataset?.id;
        if(action === "picked") await markPickedUp(id);
        if(action === "delete") await deleteOrder(id);
      });

      // Cash app events
      $("btnCashEmail")?.addEventListener("click", openCashMail);
      $("btnCashCopyMail")?.addEventListener("click", async ()=>{
        const val = $("cashMailPreview")?.value || "";
        if(!val.trim()){ alert("‚ö†Ô∏è Rien √† copier."); return; }
        try{ await navigator.clipboard.writeText(val); alert("‚úÖ Email copi√©."); }
        catch{ $("cashMailPreview")?.select(); document.execCommand("copy"); alert("‚úÖ Email copi√©."); }
      });
      $("btnCashPrint")?.addEventListener("click", printCash);
      $("btnCashReset")?.addEventListener("click", ()=>resetCashInputs(true));      $("btnCashAlertsReload")?.addEventListener("click", loadCashAlertsAdmin);
      $("cashStoreSelect")?.addEventListener("change", loadCashForCurrentTarget);
      $("btnReloadCashAdmin")?.addEventListener("click", loadCashForCurrentTarget);

      $("cashDate")?.addEventListener("change", loadCashForCurrentTarget);

      $("cashTurnover")?.addEventListener("input", ()=>{
        computeCashLocalOnly();
        saveCashToSupabase();
      });

      $("cashExpected")?.addEventListener("input", ()=>{
        computeCashLocalOnly();
        saveCashToSupabase();
      });

      document.addEventListener("input", (e)=>{
        if (e.target && e.target.classList && e.target.classList.contains("cashQty")){
          computeCashLocalOnly();
          saveCashToSupabase();
        }
      });

      // ESC closes modals
      document.addEventListener("keydown", (e)=>{
        if (e.key !== "Escape") return;
        if ($("waBackdrop")?.style?.display === "flex") closeWAModal();
        if ($("settingsBackdrop")?.style?.display === "flex") closeSettings();
      });

      // Debug global erreurs
      window.addEventListener("error", (e) => setDebug("JS error: " + (e.message || "inconnue")));
      window.addEventListener("unhandledrejection", (e) => setDebug("Promise error: " + (e.reason?.message || e.reason || "inconnue")));

      // ===== HUB buttons =====
      $("btnOpenOrders")?.addEventListener("click", openOrdersFromHub);
      $("btnOpenApp2")?.addEventListener("click", openCashFromHub);
      $("btnOpenApp3")?.addEventListener("click", ()=> alert("üß© Nouvelle app : √† venir !"));

      $("btnBackToHub")?.addEventListener("click", backToHub);
      $("btnBackToHubFromCash")?.addEventListener("click", backToHub);

      // =========================
      // Auth listener + boot
      // =========================
      supabaseClient.auth.onAuthStateChange(async (_event, session) => {
        if (isLoggingOut) return;

        const user = session?.user;

        // ‚úÖ si on est sur un lien de recovery => on affiche le reset, pas de redirection
        if (isRecoveryFlow()) {
          showLogin();
          show($("resetCard"), true);
          allowAutoLogin = false;
          return;
        }

        if (!user) {
          showLogin();
          return;
        }

        if (!allowAutoLogin) {
          showLogin();
          return;
        }

        if (hasBooted) return;
        hasBooted = true;

        try{
          await enterAfterLogin(user.email || "connect√©");
        }catch(err){
          console.error(err);
          alert("‚ùå " + (err?.message || err));
          showLogin();
          hasBooted = false;
        }
      });

      (async ()=>{
        // ‚úÖ recovery: on reste sur l‚Äô√©cran de reset
        if(isRecoveryFlow()){
          showLogin();
          show($("resetCard"), true);
          return;
        }

        const { data } = await supabaseClient.auth.getSession();

        if (isLoggingOut) { showLogin(); return; }

        if (data?.session?.user) {
          if (!allowAutoLogin) { showLogin(); return; }
          if (!hasBooted) {
            hasBooted = true;
            try{
              await enterAfterLogin(data.session.user.email || "connect√©");
            }catch(err){
              console.error(err);
              alert("‚ùå " + (err?.message || err));
              showLogin();
              hasBooted = false;
            }
          }
        } else {
          showLogin();
        }
      })();

    })();
    </script>
    <!-- Supabase v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script nomodule>
      document.body.innerHTML = `
        <div style="padding:24px;font-family:Inter,Arial,sans-serif;color:#10211b;">
          <h2>Votre navigateur est trop ancien</h2>
          <p>Cette page utilise des fonctionnalit√©s modernes (async/await). Merci de mettre √† jour votre navigateur.</p>
        </div>
      `;
    </script>

  </div> <!-- /wrap -->

</body>
</html>

