<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vapo'Chill ‚Äì Suivi commandes</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --vc-dark:#0f2a22;
      --vc-green:#2bb673;
      --vc-mint:#e6f6ef;
      --vc-danger:#b00020;
      --vc-card:#ffffff;
      --vc-border:#dfe7e3;
      --vc-text:#10211b;
      --vc-muted:#5d6b66;

      --vc-blue:#4a7dff;
      --vc-yellow:#f6c453;
      --vc-red:#ff6b6b;
      --vc-orange:#ff9a3c;
      --vc-purple:#b9a7ff;
    }

    * { box-sizing:border-box; }
    body { font-family: 'Inter', Arial, sans-serif; margin:0; background:var(--vc-mint); color:var(--vc-text); }

    /* ===== TOP BAR (fixe) ===== */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      height:64px; background:var(--vc-dark); color:#fff;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px; z-index:1000;
      box-shadow: 0 2px 10px rgba(0,0,0,.15);
      gap:10px;
    }
    .topbar-left{ display:flex; align-items:center; gap:12px; }
    .topbar img{ height:40px; background:#fff; padding:4px; border-radius:10px; }
    .topbar-title{ display:flex; flex-direction:column; line-height:1.1; }
    .topbar-title b{ font-size:14px; }
    .topbar-title span{ font-size:12px; opacity:.9; }

    .topbar-right{
      display:flex; gap:10px; font-size:12px; opacity:.98;
      align-items:center; flex-wrap:wrap; justify-content:flex-end;
    }
    .chip{
      border:1px solid rgba(255,255,255,.22);
      border-radius:999px;
      padding:6px 10px;
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.06);
      white-space:nowrap;
    }

    .wrap { padding: 86px 18px 18px; max-width: 1280px; margin: 0 auto; }
    .small { font-size: 12px; color:var(--vc-muted); white-space:pre-wrap; }
    .card { background:var(--vc-card); border:1px solid var(--vc-border); border-radius:16px; padding:14px; margin: 12px 0; box-shadow: 0 1px 0 rgba(0,0,0,.03); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:end; }
    label { font-size: 12px; color:#32423d; display:block; margin-bottom:4px; }

    input, select, textarea {
      padding: 8px; border:1px solid #cfd8d3; border-radius:12px;
      width: 240px; background:#fff; font-family: inherit;
    }
    textarea { width: 520px; height: 70px; }

    button { padding:10px 12px; border:0; border-radius:12px; cursor:pointer; font-weight:600; }
    .primary { background:var(--vc-dark); color:#fff; }
    .light { background:#eef1f0; }
    .danger { background:var(--vc-danger); color:#fff; }
    .ok { background:var(--vc-green); color:#fff; }

    .hidden{ display:none !important; }

    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom:1px solid #eef2f0; padding:10px; text-align:left; vertical-align: top; }
    th { font-size: 12px; color:#3f4c48; }

    .pill { display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; border:1px solid #d7e0db; background:#f6f8f7; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .right { margin-left:auto; }

    /* Statuts */
    .st { font-weight: 800; }
    .st-mec { border-color:rgba(246,196,83,.55); background:rgba(246,196,83,.22); color:#6b4a00; }
    .st-com { border-color:rgba(74,125,255,.45); background:rgba(74,125,255,.16); color:#1837a8; }
    .st-rup { border-color:rgba(255,107,107,.55); background:rgba(255,107,107,.18); color:#8a1010; }
    .st-par { border-color:rgba(185,167,255,.55); background:rgba(185,167,255,.18); color:#3c2aa8; }

    /* Re√ßu */
    .receivedTag { border-color: rgba(43,182,115,.35); background: rgba(43,182,115,.12); font-weight:900; }
    .row-received { outline: 2px solid rgba(43,182,115,.25); outline-offset: -2px; animation: flash .35s ease; }
    @keyframes flash { from { background: rgba(43,182,115,.10); } to { background: transparent; } }

    /* Tabs */
    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tab { padding:8px 10px; border-radius:999px; border:1px solid #d7e0db; background:#f6f8f7; cursor:pointer; font-size:12px; user-select:none; }
    .tab.active { background:var(--vc-dark); color:#fff; border-color:var(--vc-dark); }

    /* Checkbox */
    .cb { display:flex; align-items:center; gap:8px; font-size:12px; color:#2f3a36; user-select:none; }
    .cb input { width:auto; transform: scale(1.15); }

    /* Dashboard */
    .dashboard{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap:12px;
      margin: 12px 0;
    }
    .statCard{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .statCard .label{ font-size:12px; color:var(--vc-muted); font-weight:700; display:flex; align-items:center; gap:8px; }
    .statCard .value{ font-size:22px; font-weight:900; }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .dot.mec{ background: var(--vc-yellow); }
    .dot.com{ background: var(--vc-blue); }
    .dot.rup{ background: var(--vc-red); }
    .dot.recu{ background: var(--vc-green); }

    /* ===== MODALS ===== */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:16px;
    }
    .modal{
      width:min(820px, 100%);
      background:#fff;
      border-radius:18px;
      border:1px solid var(--vc-border);
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      overflow:hidden;
      transform: translateY(6px);
      animation: pop .14s ease-out;
    }
    @keyframes pop{
      from{ transform: translateY(16px); opacity:.7; }
      to{ transform: translateY(6px); opacity:1; }
    }
    .modalHeader{
      background: #f6f8f7;
      border-bottom:1px solid var(--vc-border);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader b{ font-size:14px; }
    .modalBody{ padding:14px 16px; }
    .modalFooter{
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      border-top:1px solid var(--vc-border);
      background:#fff;
      align-items:center;
    }

    .waBox{
      border:1px solid var(--vc-border);
      background:#fbfcfb;
      border-radius:14px;
      padding:12px;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.45;
      width:100%;
      min-height: 220px;
      resize:vertical;
      font-family: inherit;
    }

    .toggleRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      font-size:12px;
      color:#2f3a36;
    }
    .toggleRow input{ transform: scale(1.15); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field input, .field textarea, .field select{ width:100%; }

    @media (max-width: 900px){
      .grid2{ grid-template-columns:1fr; }
    }
    @media (max-width: 700px){
      input, select, textarea { width: 100%; }
      textarea { width: 100%; }
      .topbar-right { gap:6px; }
    }

    /* =========================
       LOGIN ‚Äî SOBRE LUXE
       ========================= */
    .loginStage{
      min-height: calc(100vh - 86px);
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 26px 0;
    }

    .loginShell{
      width:min(980px, 100%);
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:16px;
      align-items:stretch;
    }

    .loginHero{
      border-radius:22px;
      padding:22px;
      color:#fff;
      background:
        radial-gradient(800px 420px at 20% 10%, rgba(43,182,115,.35), transparent 55%),
        radial-gradient(700px 380px at 90% 40%, rgba(74,125,255,.22), transparent 55%),
        linear-gradient(135deg, #0f2a22, #12382c);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 55px rgba(0,0,0,.18);
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      overflow:hidden;
      position:relative;
    }

    .heroTop{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .heroLogo{
      width:44px;height:44px;
      border-radius:14px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      letter-spacing:-.02em;
    }

    .heroTitle{
      display:flex;
      flex-direction:column;
      line-height:1.1;
    }
    .heroTitle b{ font-size:13px; opacity:.95; }
    .heroTitle span{ font-size:12px; opacity:.82; }

    .loginHero h1{
      margin:16px 0 8px;
      font-size:28px;
      letter-spacing:-.02em;
      line-height:1.1;
    }
    .loginHero p{
      margin:0;
      opacity:.9;
      font-size:13px;
      line-height:1.55;
      max-width: 46ch;
    }

    .heroFoot{
      margin-top:14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      opacity:.96;
      font-size:12px;
    }
    .heroChip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.16);
    }

    .loginCard{
      background:var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:20px;
      box-shadow: 0 18px 55px rgba(0,0,0,.08);
    }

    .loginCard h2{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:-.01em;
    }
    .loginCard .sub{
      font-size:12px;
      color:var(--vc-muted);
    }

    .loginGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
      margin-top:14px;
    }

    .fieldBox{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .fieldBox label{
      font-size:12px;
      color:#32423d;
      font-weight:800;
    }

    .inputWrap{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid #cfd8d3;
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      transition: box-shadow .12s ease, border-color .12s ease;
    }
    .inputWrap:focus-within{
      border-color: rgba(15,42,34,.55);
      box-shadow: 0 0 0 4px rgba(15,42,34,.10);
    }
    .inputIcon{
      font-size:14px;
      opacity:.75;
      width:18px;
      text-align:center;
    }

    .inputWrap input{
      border:0 !important;
      outline:none !important;
      width:100%;
      padding:0 !important;
      border-radius:0 !important;
      background:transparent !important;
      font-family:inherit;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
      align-items:center;
    }

    .btnPrimary{
      background:var(--vc-dark);
      color:#fff;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:900;
      cursor:pointer;
      transition: transform .05s ease, opacity .12s ease;
    }
    .btnPrimary:active{ transform: translateY(1px); }
    .btnPrimary[disabled]{ opacity:.6; cursor:not-allowed; }

    .btnGhost{
      background:#eef1f0;
      border:0;
      border-radius:14px;
      padding:12px 14px;
      font-weight:800;
      cursor:pointer;
    }

    .alert{
      margin-top:10px;
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      border:1px solid rgba(176,0,32,.22);
      background: rgba(176,0,32,.06);
      color:#7c0016;
      display:none;
      white-space:pre-wrap;
    }
    .alert.show{ display:block; }

    .loginHint{
      margin-top:10px;
      font-size:12px;
      color:var(--vc-muted);
      line-height:1.45;
    }

    @media (max-width: 900px){
      .loginShell{ grid-template-columns:1fr; }
    }

    /* =========================
       HUB APPS (MENU) ‚Äî NOUVEAU
       ========================= */
    .hubStage{
      min-height: calc(100vh - 86px);
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding: 26px 0;
    }
    .hubShell{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    .hubHeader{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:18px 18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    .hubHeader b{ font-size:16px; }
    .hubHeader .small{ margin-top:4px; }
    .hubGrid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:14px;
    }
    .appTile{
      background: var(--vc-card);
      border:1px solid var(--vc-border);
      border-radius:22px;
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 160px;
    }
    .appTile .top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .appIcon{
      width:42px;height:42px;
      border-radius:14px;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(15,42,34,.08);
      border:1px solid rgba(15,42,34,.12);
      font-size:18px;
    }
    .appTile h3{
      margin:0;
      font-size:14px;
      letter-spacing:-.01em;
    }
    .appTile p{
      margin:0;
      font-size:12px;
      color: var(--vc-muted);
      line-height:1.45;
      max-width: 60ch;
    }
    .appTile .actions{
      margin-top:auto;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }

    /* Barre retour dans les applis ‚Äî NOUVEAU */
    .appTopActions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin: 10px 0 2px;
    }
    .backBtn{
      background:#eef1f0;
      border:0;
      border-radius:14px;
      padding:10px 12px;
      font-weight:900;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-left">
      <img src="./logo-vapochill.jpeg" alt="Vapo'Chill" onerror="this.style.display='none'">
      <div class="topbar-title">
        <b id="uiTitle">Vapo'Chill ‚Äì Connexion</b>
        <span id="uiSub">‚Äî</span>
      </div>
    </div>

    <div class="topbar-right">
      <button class="light hidden" style="padding:8px 10px;border-radius:999px" id="btnSettings" type="button">‚öôÔ∏è Param√®tres</button>

      <div class="chip">üïí <span id="clock">--:--</span></div>
      <div class="chip">üë§ <span id="userLabel">non connect√©</span></div>
      <button class="light hidden" style="padding:8px 10px;border-radius:999px" id="btnLogout" type="button">D√©connexion</button>
    </div>
  </div>

  <div class="wrap">

    <!-- ====== LOGIN (SOBRE LUXE) ====== -->
    <div class="loginStage" id="loginCard">
      <div class="loginShell">

        <div class="loginHero">
          <div>
            <div class="heroTop">
              <div class="heroLogo">VC</div>
              <div class="heroTitle">
                <b>Vapo‚ÄôChill</b>
                <span>Suivi commandes interne</span>
              </div>
            </div>

            <h1>Connexion</h1>
            <p>
              Acc√®de √† la gestion des commandes, statuts, historique et messages WhatsApp.
              Interface pens√©e pour aller vite, sans erreurs.
            </p>
          </div>

          <div class="heroFoot">
            <div class="heroChip">üîê Acc√®s s√©curis√©</div>
            <div class="heroChip">‚ö° Rapide</div>
            <div class="heroChip">üì¶ Suivi clair</div>
          </div>
        </div>

        <div class="loginCard">
          <h2>Se connecter</h2>
          <div class="sub">Email boutique ou admin.</div>

          <div class="loginGrid">
            <div class="fieldBox">
              <label>Email</label>
              <div class="inputWrap">
                <div class="inputIcon">‚úâÔ∏è</div>
                <input id="email" placeholder="boutique.toursnord@vapochill.fr" autocomplete="username">
              </div>
            </div>

            <div class="fieldBox">
              <label>Mot de passe</label>
              <div class="inputWrap">
                <div class="inputIcon">üîí</div>
                <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
              </div>
            </div>

            <div class="btnRow">
              <button id="btnLogin" class="btnPrimary" type="button">Se connecter</button>
              <button class="btnGhost" id="btnReset" type="button">Mot de passe oubli√©</button>
            </div>

            <div class="alert" id="authAlert"></div>
            <div class="small" id="authMsg"></div>

            <!-- Reset password block -->
            <div class="card hidden" id="resetCard" style="margin-top:12px">
              <b>üîí D√©finir un nouveau mot de passe</b>
              <div class="small" style="margin-top:6px">Ce bloc s‚Äôaffiche quand tu arrives via un lien de r√©cup√©ration.</div>
              <div style="height:10px"></div>
              <label>Nouveau mot de passe</label>
              <input id="newPassword" type="password" style="width:100%" placeholder="Nouveau mot de passe">
              <div class="row" style="margin-top:10px">
                <button class="ok" id="btnUpdatePass" type="button">Enregistrer</button>
                <span class="small" id="resetMsg"></span>
              </div>
            </div>

            <!-- Debug (optionnel) -->
            <div class="card hidden" style="margin-top:12px" id="debugCard">
              <b style="font-size:13px;">Debug</b>
              <div class="small" id="debug">‚Äî</div>
            </div>

            <div class="loginHint">
              Astuce : si une boutique ‚Äúne voit rien‚Äù, v√©rifie l‚Äôemail dans la table <b>stores</b> (champ <b>email</b>).
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- ===============================
         HUB / MENU DES APPLICATIONS
         (NOUVEAU : s'affiche apr√®s login)
         =============================== -->
    <div class="hidden" id="hubRoot">
      <div class="hubStage">
        <div class="hubShell">

          <div class="hubHeader">
            <div>
              <b>Applications internes</b>
              <div class="small">Choisis l‚Äôapplication √† ouvrir.</div>
            </div>
            <div class="actions">
              <!-- Tu peux laisser vide, ou ajouter des boutons plus tard -->
            </div>
          </div>

          <div class="hubGrid">
            <!-- App 1 -->
            <div class="appTile">
              <div class="top">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div class="appIcon">üì¶</div>
                  <div>
                    <h3>Commandes clients</h3>
                    <p>Cr√©er, suivre, historiser, cocher ‚ÄúRe√ßu‚Äù, WhatsApp en 2 clics.</p>
                  </div>
                </div>
              </div>
              <div class="actions">
                <button id="btnOpenOrders" class="primary" type="button">Ouvrir</button>
              </div>
            </div>

            <!-- App 2 (placeholder pour plus tard) -->
            <div class="appTile">
              <div class="top">
                <div style="display:flex;align-items:center;gap:10px;">
                  <div class="appIcon">‚ú®</div>
                  <div>
                    <h3>Nouvelle application</h3>
                    <p>√Ä venir : on la construira ensemble. (Cette tuile est pr√™te.)</p>
                  </div>
                </div>
              </div>
              <div class="actions">
                <button id="btnOpenApp2" class="light" type="button">Bient√¥t</button>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- ===============================
         APP : COMMANDES CLIENTS (EXISTANT)
         (NOUVEAU : bouton retour vers hub)
         =============================== -->
    <div class="hidden" id="appRoot">

      <!-- Barre actions / retour -->
      <div class="appTopActions">
        <button class="backBtn" id="btnBackToHub" type="button">‚Üê Retour aux applications</button>
      </div>

      <!-- ADMIN : select boutique -->
      <div class="card hidden" id="adminCard">
        <div class="row" style="justify-content:space-between; align-items:end;">
          <div>
            <b>Mode admin</b>
            <div class="small">Choisis une boutique pour afficher ses commandes.</div>
          </div>
          <div class="row">
            <div>
              <label>Boutique</label>
              <select id="storeSelect" style="width:320px"></select>
            </div>
            <button class="light" id="btnReloadAdmin" type="button">Recharger</button>
          </div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div class="dashboard">
        <div class="statCard">
          <div>
            <div class="label"><span class="dot mec"></span> Mettre en commande</div>
            <div class="value" id="statMEC">0</div>
          </div>
          <div class="pill st st-mec">En attente</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot com"></span> Commander</div>
            <div class="value" id="statCOM">0</div>
          </div>
          <div class="pill st st-com">Command√©e</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot rup"></span> Rupture de stock</div>
            <div class="value" id="statRUP">0</div>
          </div>
          <div class="pill st st-rup">Rupture</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot recu"></span> Re√ßu (coch√©)</div>
            <div class="value" id="statRECU">0</div>
          </div>
          <div class="pill receivedTag">Re√ßu ‚úÖ</div>
        </div>
      </div>

      <!-- ADD ORDER -->
      <div class="card" id="addCard">
        <b>Ajouter une commande</b>
        <div class="row" style="margin-top:10px">
          <div>
            <label>Client</label>
            <input id="client" placeholder="Nom client">
          </div>
          <div>
            <label>Num√©ro</label>
            <input id="tel" placeholder="06 12 34 56 78">
          </div>
          <div>
            <label>Article</label>
            <input id="article" placeholder="Article command√©">
          </div>
          <div>
            <label>Quantit√©</label>
            <input id="qty" type="number" min="1" value="1">
          </div>
          <div>
            <label>Date</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Statut</label>
            <select id="statut">
              <option>Mettre en commande</option>
              <option>Commander</option>
              <option>Rupture de stock</option>
              <option>Re√ßu partiellement</option>
            </select>
          </div>
          <div>
            <label>Vendeur</label>
            <select id="seller"></select>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Notes</label>
            <textarea id="notes" placeholder="Notes internes"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <button id="btnAdd" class="primary" type="button">Ajouter</button>
          <button id="btnClear" class="light" type="button">Vider</button>
          <span class="small" id="msg"></span>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div>
            <b>Commandes</b>
            <div class="small">Gestion des commandes en cours et archiv√©es.</div>
          </div>
          <div class="row" style="gap:8px">
            <input id="search" placeholder="Rechercher..." style="width:220px">
            <select id="filterStatus" style="width:180px">
              <option value="">Tous statuts</option>
              <option>Mettre en commande</option>
              <option>Commander</option>
              <option>Rupture de stock</option>
              <option>Re√ßu partiellement</option>
            </select>
            <select id="antiError">
              <option value="on">Anti-erreur: ON</option>
              <option value="off">Anti-erreur: OFF</option>
            </select>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" id="tabActive">En cours (<span id="countActive">0</span>)</div>
          <div class="tab" id="tabHistory">Historique (<span id="countHistory">0</span>)</div>
          <div class="tab right">Affich√©es: <b id="countShown">0</b></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Article</th>
              <th>Statut</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div> <!-- /appRoot -->

    <!-- ====== WHATSAPP MODAL ====== -->
    <div class="modalBackdrop" id="waBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalHeader">
          <b>WhatsApp ‚Äì Pr√©parer le message</b>
          <button class="light" id="btnCloseWA" type="button">‚úñ</button>
        </div>
        <div class="modalBody">
          <div class="small" id="waMeta"></div>
          <div style="height:8px"></div>

          <label>Template</label>
          <select id="waTemplate" style="width:100%">
            <option value="arrivee">‚úÖ Arriv√©e boutique</option>
            <option value="rupture">‚ùå Rupture / d√©lai</option>
            <option value="relance">‚è≥ Relance fournisseur</option>
            <option value="partiel">üì¶ Re√ßu partiellement</option>
          </select>

          <div style="height:8px"></div>

          <label>Message</label>
          <textarea id="waText" class="waBox"></textarea>

          <div class="toggleRow">
            <input id="waNoPreview" type="checkbox">
            <span>Ouvrir directement WhatsApp sans pr√©visualisation</span>
          </div>
        </div>
        <div class="modalFooter">
          <div class="actions">
            <button class="light" id="btnCancelWA" type="button">Annuler</button>
            <button class="light" id="btnResetWA" type="button">R√©initialiser</button>
            <button class="light" id="btnCopyWA" type="button">Copier</button>
          </div>
          <div class="actions">
            <button class="primary" id="btnOpenWA" type="button">Ouvrir WhatsApp</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SETTINGS MODAL ====== -->
    <div class="modalBackdrop" id="settingsBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalHeader">
          <b>Param√®tres WhatsApp</b>
          <button class="light" id="btnCloseSettings" type="button">‚úñ</button>
        </div>
        <div class="modalBody">
          <div class="row" style="align-items:end">
            <div class="field">
              <label>Nom boutique</label>
              <input id="setShopName" placeholder="Vapo'Chill">
            </div>
            <div class="field">
              <label>Horaires (optionnel, ajout√© dans la signature)</label>
              <input id="setHours" placeholder="Ex: Lun-Sam 10h-19h">
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label>Signature (utilise {vendeur})</label>
            <input id="setSignature" placeholder="{vendeur} - Vapochill">
            <div class="small">Ex: <b>{vendeur} - Vapo'Chill</b> ou juste <b>Vapo'Chill</b></div>
          </div>

          <div style="height:14px"></div>

          <b style="font-size:13px;">Templates WhatsApp</b>
          <div class="small">Variables : <b>{article}</b> <b>{client}</b> <b>{vendeur}</b> <b>{boutique}</b> <b>{horaires}</b></div>

          <div style="height:10px"></div>

          <div class="grid2">
            <div class="field">
              <label>‚úÖ Arriv√©e boutique</label>
              <textarea id="tplArrivee" class="waBox" style="min-height:150px"></textarea>
            </div>
            <div class="field">
              <label>‚ùå Rupture / d√©lai</label>
              <textarea id="tplRupture" class="waBox" style="min-height:150px"></textarea>
            </div>
            <div class="field">
              <label>‚è≥ Relance fournisseur</label>
              <textarea id="tplRelance" class="waBox" style="min-height:150px"></textarea>
            </div>
            <div class="field">
              <label>üì¶ Re√ßu partiellement</label>
              <textarea id="tplPartiel" class="waBox" style="min-height:150px"></textarea>
            </div>
          </div>
        </div>

        <div class="modalFooter">
          <div class="small">Les param√®tres WhatsApp sont sauvegard√©s sur ce PC (localStorage).</div>
          <div class="actions">
            <button class="light" id="btnResetSettings" type="button">R√©initialiser</button>
            <button class="primary" id="btnSaveSettings" type="button">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Supabase v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script nomodule>
      document.body.innerHTML = `
        <div style="padding:24px;font-family:Inter,Arial,sans-serif;color:#10211b;">
          <h2>Votre navigateur est trop ancien</h2>
          <p>Cette page utilise des fonctionnalit√©s modernes (async/await). Merci de mettre √† jour votre navigateur.</p>
        </div>
      `;
    </script>
<script type="module">
(async function(){
  // =========================
  // Helpers
  // =========================
  const $ = (id)=>document.getElementById(id);
  const show = (el, yes)=> el.classList.toggle("hidden", !yes);
  const setAuthMsg = (t)=> { $("authMsg").textContent = t || ""; };
  const setResetMsg = (t)=> { $("resetMsg").textContent = t || ""; };
  const setMsg = (t)=> { $("msg").textContent = t || ""; };

  // ‚úÖ FIX: setDebug ne plante plus si #debug n'existe pas
  const setDebug = (t)=> {
    const el = $("debug");
    if (el) el.textContent = t || "";
  };

  // ‚úÖ Luxe login helpers
  function setAuthAlert(message){
    const box = $("authAlert");
    if(!box) return;
    box.textContent = message || "";
    box.classList.toggle("show", Boolean(message));
  }
  function setLoginLoading(isLoading){
    const btn = $("btnLogin");
    if(!btn) return;
    btn.disabled = Boolean(isLoading);
    btn.textContent = isLoading ? "Connexion‚Ä¶" : "Se connecter";
  }

  function canWrite(){
    return role === "shop" || role === "admin";
  }

  function escapeHtml(s) {
    return (s || "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;");
  }

  function isRecoveryFlow(){
    const h=(location.hash||"").toLowerCase();
    const q=(location.search||"").toLowerCase();
    return h.includes("access_token=") || q.includes("type=recovery") || q.includes("recovery");
  }

  // =========================
  // Supabase config
  // =========================
  const SUPABASE_URL = "https://lhddwfeaoxnlflqlihdg.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZGR3ZmVhb3hubGZscWxpaGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTI0NjcsImV4cCI6MjA4MzE4ODQ2N30.5Po48JdTbLZhcXjyJ48Il511DpiYNPdUZq4H-HNPAa4";

  // ‚úÖ Ton URL GitHub Pages (OK)
  const SITE_URL = "https://vapochill-commandes.github.io/vapochill-suivi-commandes";

  async function loadSupabaseScript(src){
    return new Promise((resolve, reject) => {
      const script = document.createElement("script");
      script.src = src;
      script.async = true;
      script.onload = () => resolve();
      script.onerror = () => reject(new Error("load failed: " + src));
      document.head.appendChild(script);
    });
  }

  async function ensureSupabaseLoaded(){
    if (window.supabase?.createClient) return true;
    try{ await loadSupabaseScript("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"); }catch(e){ console.warn(e); }
    if (window.supabase?.createClient) return true;
    try{ await loadSupabaseScript("https://unpkg.com/@supabase/supabase-js@2"); }catch(e){ console.warn(e); }
    return Boolean(window.supabase?.createClient);
  }

  const supabaseReady = await ensureSupabaseLoaded();
  if(!supabaseReady){
    alert("‚ùå La librairie Supabase ne charge pas (CDN bloqu√© / r√©seau).");
    setAuthMsg("‚ùå Supabase indisponible. V√©rifie la connexion ou le bloqueur de pub.");
    return;
  }

  const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  window.supabaseClient = supabaseClient;

  let isLoggingOut = false;
  let hasBooted = false;
  let allowAutoLogin = false;

  // =========================
  // App config
  // =========================
  const USERS = ["Laetitia","Marco","Charlotte","Nico","Alan","Corentin","Mathieu","Romain"];

  // WhatsApp modal mode
  const WA_PREVIEW_KEY = "wa_preview_mode_v1";
  if (!localStorage.getItem(WA_PREVIEW_KEY)) localStorage.setItem(WA_PREVIEW_KEY, "preview");

  // Settings
  const SETTINGS_KEY = "vc_settings_v1";

  const DEFAULT_SETTINGS = {
    shopName: "Vapo'Chill",
    hours: "",
    signature: "{vendeur} - Vapochill",
    templates: {
      arrivee:
`Bonjour,

Votre commande {article} est bien arriv√©e en boutique
Vous pouvez passer quand vous voulez

{signature}`,
      rupture:
`Bonjour,

Petit retour pour votre commande {article} : elle est en rupture chez le fournisseur.
Je vous tiens au courant d√®s que j‚Äôai une date

{signature}`,
      relance:
`Bonjour,

Je reviens vers vous : votre commande {article} est toujours en attente.
On relance le fournisseur et on vous tient inform√©

{signature}`,
      partiel:
`Bonjour,

Une partie de votre commande {article} est arriv√©e en boutique
Je vous confirme le reste d√®s r√©ception

{signature}`
    }
  };

  function loadSettings(){
    try{
      const raw = localStorage.getItem(SETTINGS_KEY);
      if (!raw) return structuredClone(DEFAULT_SETTINGS);
      const obj = JSON.parse(raw);
      return {
        ...structuredClone(DEFAULT_SETTINGS),
        ...obj,
        templates: { ...structuredClone(DEFAULT_SETTINGS.templates), ...(obj.templates || {}) }
      };
    }catch{
      return structuredClone(DEFAULT_SETTINGS);
    }
  }
  function saveSettingsToStorage(settings){
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
  }
  function applySettingsToUI(shopNameOverride){
    const s = loadSettings();
    const name = shopNameOverride || s.shopName || "Vapo'Chill";
    $("uiTitle").textContent = `${name} ‚Äì Suivi commandes`;
  }

  // =========================
  // Clock
  // =========================
  function tickClock(){
    const d = new Date();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    $("clock").textContent = `${hh}:${mm}`;
  }
  setInterval(tickClock, 1000);
  tickClock();

  // =========================
  // State
  // =========================
  let currentView = "active";
  let role = null; // "admin" | "shop"
  let profile = null; // profiles row
  let myStoreId = null;
  let myStoreName = null;
  let storesCache = [];
  let ordersCache = [];
  let waPendingOrderId = null;

  // =========================
  // NAVIGATION HUB / APPS
  // =========================
  function showLogin(){
    $("uiTitle").textContent = "Vapo'Chill ‚Äì Connexion";
    $("uiSub").textContent = "‚Äî";
    $("userLabel").textContent = "non connect√©";

    show($("btnLogout"), false);
    show($("btnSettings"), false);

    show($("loginCard"), true);
    show($("hubRoot"), false);
    show($("appRoot"), false);

    show($("resetCard"), isRecoveryFlow());
    setAuthMsg("");
    setResetMsg("");
    setDebug("");

    setAuthAlert("");
    setLoginLoading(false);

    hasBooted = false;
  }

  function showHub(email){
    // Topbar info
    $("userLabel").textContent = email || "connect√©";

    // Pages
    show($("loginCard"), false);
    show($("hubRoot"), true);
    show($("appRoot"), false);

    // Buttons topbar
    show($("btnLogout"), true);
    show($("btnSettings"), false); // settings ne sert que dans l'app commandes

    // Title/sub
    applySettingsToUI(myStoreName || null);
    // si admin, on peut afficher "ADMIN" sinon le nom boutique
    if (role === "admin") $("uiSub").textContent = "ADMIN ‚Äì toutes boutiques";
    else $("uiSub").textContent = myStoreName || "Boutique";
  }

  function showOrdersApp(){
    show($("loginCard"), false);
    show($("hubRoot"), false);
    show($("appRoot"), true);

    show($("btnLogout"), true);
    show($("btnSettings"), true); // settings uniquement dans commandes
  }

  // =========================
  // Auth actions
  // =========================
  async function login(){
    try{
      setAuthMsg("");
      setAuthAlert("");

      const email = $("email").value.trim();
      const password = $("password").value.trim();
      if(!email || !password){
        setAuthAlert("‚ö†Ô∏è Mets email + mot de passe.");
        return;
      }

      setLoginLoading(true);
      allowAutoLogin = true;

      const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
      if(error){
        setAuthAlert("‚ùå " + error.message);
        return;
      }
      setAuthMsg("‚úÖ Connect√©.");
    }catch(e){
      setAuthAlert("‚ùå " + (e?.message || e));
    }finally{
      setLoginLoading(false);
    }
  }

  async function logout(){
    try{
      isLoggingOut = true;
      hasBooted = false;
      allowAutoLogin = false;

      await supabaseClient.auth.signOut({ scope: "local" });
    } catch (e) {
      console.warn("signOut error (ignored):", e);
    } finally {
      for (const k of Object.keys(localStorage)) {
        if (k.startsWith("sb-") && k.includes("auth")) localStorage.removeItem(k);
      }
      for (const k of Object.keys(sessionStorage)) {
        if (k.startsWith("sb-") && k.includes("auth")) sessionStorage.removeItem(k);
      }

      showLogin();
      setTimeout(()=>{ isLoggingOut = false; }, 1200);
    }
  }

  async function updatePassword(){
    try{
      setResetMsg("");
      const pass = $("newPassword").value.trim();
      if(pass.length < 6){ setResetMsg("‚ö†Ô∏è Min 6 caract√®res."); return; }

      const { error } = await supabaseClient.auth.updateUser({ password: pass });
      if(error){ setResetMsg("‚ùå " + error.message); return; }
      setResetMsg("‚úÖ Mot de passe modifi√©. Reconnecte-toi.");
    }catch(e){
      setResetMsg("‚ùå " + (e?.message || e));
    }
  }

  // =========================
  // Data helpers
  // =========================
  function statusClass(statut) {
    if (statut === "Mettre en commande") return "st st-mec";
    if (statut === "Commander") return "st st-com";
    if (statut === "Rupture de stock") return "st st-rup";
    if (statut === "Re√ßu partiellement") return "st st-par";
    return "st";
  }

  function setTodayDefault() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    $("date").value = `${yyyy}-${mm}-${dd}`;
  }

  function timeSince(iso) {
    const d = new Date(iso);
    if (isNaN(d.getTime())) return "";
    let diff = Math.max(0, Date.now() - d.getTime());
    const min = Math.floor(diff / 60000);
    const h = Math.floor(min / 60);
    const m = min % 60;
    const j = Math.floor(h / 24);
    const hh = h % 24;
    if (j > 0) return `il y a ${j}j ${hh}h`;
    if (h > 0) return `il y a ${h}h ${m}m`;
    return `il y a ${m}m`;
  }

  function phoneToWhatsAppNumber(phone) {
    let p = (phone || "").replace(/[^\d+]/g, "");
    p = p.replace(/\D/g, "");
    if (!p) return "";
    if (p.startsWith("0") && p.length === 10) return "33" + p.slice(1);
    if (p.startsWith("33")) return p;
    if (p.startsWith("0033")) return "33" + p.slice(4);
    return p;
  }

  function antiErrorOn(){
    return $("antiError")?.value === "on";
  }

  function isUuid(value){
    return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(value || "");
  }

  function getWAPreviewMode(){
    return localStorage.getItem(WA_PREVIEW_KEY) || "preview";
  }
  function setWAPreviewMode(mode){
    localStorage.setItem(WA_PREVIEW_KEY, mode);
  }

  function templateToMessage(template, order){
    const s = loadSettings();
    const shop = myStoreName || s.shopName || "Vapo'Chill";
    const hours = s.hours || "";
    const vendeur = ($("seller")?.value || "").trim();

    const signature = (s.signature || "{vendeur} - Vapochill")
      .replaceAll("{vendeur}", vendeur)
      .replaceAll("{boutique}", shop)
      .replaceAll("{horaires}", hours);

    return (template || "")
      .replaceAll("{article}", order.article || "votre commande")
      .replaceAll("{client}", order.client || "")
      .replaceAll("{vendeur}", vendeur)
      .replaceAll("{boutique}", shop)
      .replaceAll("{horaires}", hours)
      .replaceAll("{signature}", signature);
  }

  function getTemplateByKey(key){
    const s = loadSettings();
    const t = s.templates || {};
    return t[key] || "";
  }

  function openWhatsAppWithText(order, customText) {
    const num = phoneToWhatsAppNumber(order.tel);
    if (!num) { alert("‚ö†Ô∏è Num√©ro invalide pour WhatsApp."); return; }
    const text = encodeURIComponent(customText || "");
    const url = `https://wa.me/${num}?text=${text}`;
    window.open(url, "_blank");
  }

  // =========================
  // Supabase: profile / stores / orders
  // =========================
  async function fetchProfile(){
    const { data: ures, error: uerr } = await supabaseClient.auth.getUser();
    if(uerr) throw new Error(uerr.message);
    const uid = ures?.user?.id;
    if(!uid) return null;

    const { data, error } = await supabaseClient
      .from("profiles")
      .select("role, store_id, display_name")
      .eq("user_id", uid)
      .maybeSingle();

    if(error) throw new Error("profiles: " + error.message);
    if(!data) throw new Error("Profil introuvable (table profiles).");
    return data;
  }

  async function fetchStores(){
    const { data, error } = await supabaseClient
      .from("stores")
      .select("id,name,slug,email")
      .order("name");
    if(error) throw new Error("stores: " + error.message);
    storesCache = data || [];
  }

  function normalizeEmail(email){
    return (email || "").trim().toLowerCase();
  }

  function findStoreByEmail(email){
    const target = normalizeEmail(email);
    if (!target) return null;
    return storesCache.find(store => normalizeEmail(store.email) === target) || null;
  }

  async function fetchStoreByEmail(email){
    const target = normalizeEmail(email);
    if (!target) return null;
    const { data, error } = await supabaseClient
      .from("stores")
      .select("id,name,email")
      .eq("email", target)
      .maybeSingle();
    if (error) throw new Error("stores: " + error.message);
    return data || null;
  }

  async function getCurrentUserEmail(){
    const { data } = await supabaseClient.auth.getUser();
    return data?.user?.email || "";
  }

  async function ensureStoreId(email){
    if (myStoreId) return myStoreId;

    const userEmail = normalizeEmail(email || await getCurrentUserEmail());
    if (!userEmail) return null;

    if (!storesCache.length) await fetchStores();

    let matchedStore = findStoreByEmail(userEmail);
    if (!matchedStore) matchedStore = await fetchStoreByEmail(userEmail);
    if (!matchedStore?.id) return null;

    myStoreId = matchedStore.id;
    myStoreName = matchedStore.name || myStoreName;

    try{
      const { data } = await supabaseClient.auth.getUser();
      const uid = data?.user?.id;
      if (uid) {
        await supabaseClient
          .from("profiles")
          .update({ store_id: matchedStore.id })
          .eq("user_id", uid);
      }
    }catch(err){
      console.warn("store_id update failed:", err?.message || err);
    }

    return myStoreId;
  }

  function fillStoreSelect(){
    $("storeSelect").innerHTML = storesCache.map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`).join("");
    if(storesCache[0]) $("storeSelect").value = storesCache[0].id;
  }

  function getActiveAndHistory(list){
    const active = [];
    const history = [];
    for(const o of list){
      if(o.picked_up_at) history.push(o);
      else active.push(o);
    }
    return { active, history };
  }

  async function loadOrders(){
    setDebug("");
    setMsg("");

    let storeId = myStoreId;
    if (role === "admin") {
      storeId = $("storeSelect")?.value || "";
    }

    let query = supabaseClient
      .from("orders")
      .select("*")
      .order("created_at", { ascending: false });

    if (storeId) query = query.eq("store_id", storeId);

    const { data, error } = await query;
    if (error) { setDebug("orders: " + error.message); return; }

    ordersCache = data || [];
    render();
  }

  async function addOrder(){
    let storeId = myStoreId;

    if (role === "admin") {
      storeId = $("storeSelect")?.value || "";
      if (!storeId) {
        alert("‚ö†Ô∏è Admin : s√©lectionne une boutique avant d‚Äôajouter une commande.");
        return;
      }
    }

    if (!storeId) {
      const email = await getCurrentUserEmail();
      await ensureStoreId(email);
      storeId = myStoreId;
    }

    if (!storeId) {
      const email = await getCurrentUserEmail();
      alert(`‚ö†Ô∏è Boutique inconnue (storeId manquant).\nEmail connect√©: ${email || "inconnu"}\nV√©rifie que cet email correspond au champ email de la table stores, ou renseigne profiles.store_id.`);
      return;
    }

    const client = $("client").value.trim();
    const tel = $("tel").value.trim();
    const article = $("article").value.trim();
    const qty = Number($("qty").value || 1);
    const date = $("date").value;
    const statut = $("statut").value;
    const notes = $("notes").value.trim();
    const seller = $("seller").value;

    if (!client || !tel || !article) { setMsg("‚ö†Ô∏è Client, Num√©ro et Article obligatoires."); return; }
    if (qty <= 0) { setMsg("‚ö†Ô∏è Qt√© minimum = 1."); return; }

    setMsg("‚è≥ Ajout‚Ä¶");

    const payload = {
      store_id: storeId,
      client, tel, article, qty, date, statut, notes,
      seller,
      received_checked: false,
      updated_at: new Date().toISOString()
    };

    const { error } = await supabaseClient.from("orders").insert([payload]);
    if(error){
      setMsg("‚ùå " + error.message);
      setDebug("orders insert: " + error.message);
      alert("‚ùå Impossible d'ajouter : " + error.message);
      return;
    }

    setMsg("‚úÖ Ajout√©e.");
    resetForm();
    await loadOrders();
  }

  async function updateStatus(id, newStatus){
    if (!canWrite()) return;

    const seller = $("seller").value;
    const audit = { updated_at: new Date().toISOString() };
    if (isUuid(seller)) audit.updated_by = seller;

    const { error } = await supabaseClient
      .from("orders")
      .update({ statut: newStatus, ...audit })
      .eq("id", id);

    if(error){ alert("‚ùå " + error.message); return; }
    await loadOrders();
  }

  async function toggleReceived(id){
    if (!canWrite()) return;

    const o = ordersCache.find(x => String(x.id) === String(id));
    if(!o) return;

    const newVal = !Boolean(o.received_checked);
    const seller = $("seller").value;
    const audit = { updated_at: new Date().toISOString() };
    if (isUuid(seller)) audit.updated_by = seller;

    const { error } = await supabaseClient
      .from("orders")
      .update({ received_checked: newVal, ...audit })
      .eq("id", id);

    if(error){ alert("‚ùå " + error.message); return; }

    await loadOrders();

    const updated = ordersCache.find(x => String(x.id) === String(id));
    if(updated && updated.received_checked){
      if (getWAPreviewMode() === "direct") {
        const msg = templateToMessage(getTemplateByKey("arrivee"), updated);
        openWhatsAppWithText(updated, msg);
      } else {
        showWAModal(updated);
      }
    }
  }

  function confirmDanger(msg){
    return confirm("‚ö†Ô∏è " + msg);
  }

  async function markPickedUp(id){
    if (!canWrite()) return;

    const o = ordersCache.find(x => String(x.id) === String(id));
    if(!o) return;

    if (antiErrorOn() && !Boolean(o.received_checked)) {
      alert("‚ö†Ô∏è Coche d‚Äôabord la case ‚ÄúRe√ßu‚Äù.");
      return;
    }

    if (!confirmDanger("Confirmer : commande r√©cup√©r√©e / termin√©e ? (envoi √† l‚Äôhistorique)")) return;

    const seller = $("seller").value;
    const audit = { updated_at: new Date().toISOString() };
    if (isUuid(seller)) audit.updated_by = seller;
    const pickedBy = isUuid(seller) ? { picked_up_by: seller } : {};

    const { error } = await supabaseClient
      .from("orders")
      .update({
        picked_up_at: new Date().toISOString(),
        ...pickedBy,
        ...audit
      })
      .eq("id", id);

    if(error){ alert("‚ùå " + error.message); return; }
    await loadOrders();
  }

  async function deleteOrder(id){
    if (!canWrite()) return;

    const o = ordersCache.find(x => String(x.id) === String(id));
    if(!o) return;

    if (antiErrorOn() && currentView === "active" && !Boolean(o.received_checked)) {
      alert("‚ö†Ô∏è Anti-erreur : impossible de supprimer tant que ‚ÄúRe√ßu‚Äù n‚Äôest pas coch√©.\n(Si tu veux vraiment, mets Anti-erreur sur OFF.)");
      return;
    }

    if (!confirmDanger("Supprimer d√©finitivement ?")) return;

    const { error } = await supabaseClient.from("orders").delete().eq("id", id);
    if(error){ alert("‚ùå " + error.message); return; }
    await loadOrders();
  }

  // =========================
  // WhatsApp modal
  // =========================
  function showWAModal(order){
    waPendingOrderId = order.id;

    $("waMeta").textContent = `Client: ${order.client || "-"} ‚Ä¢ Tel: ${order.tel || "-"} ‚Ä¢ Article: ${order.article || "-"}`;

    $("waTemplate").value = "arrivee";
    $("waText").value = templateToMessage(getTemplateByKey("arrivee"), order);

    $("waNoPreview").checked = (getWAPreviewMode() === "direct");

    $("waBackdrop").style.display = "flex";
  }

  function closeWAModal(){
    if ($("waNoPreview")?.checked) setWAPreviewMode("direct");
    else setWAPreviewMode("preview");

    $("waBackdrop").style.display = "none";
    waPendingOrderId = null;
  }

  function applySelectedTemplate(){
    const id = waPendingOrderId;
    if (!id) return;

    const o = ordersCache.find(x => String(x.id) === String(id));
    if (!o) return;

    const key = $("waTemplate").value;
    $("waText").value = templateToMessage(getTemplateByKey(key), o);
  }

  async function copyWAText(){
    const val = $("waText").value || "";
    try{
      await navigator.clipboard.writeText(val);
      alert("‚úÖ Message copi√©.");
    }catch{
      $("waText").select();
      document.execCommand("copy");
      alert("‚úÖ Message copi√©.");
    }
  }

  function confirmOpenWhatsApp(){
    const id = waPendingOrderId;
    if (!id) return closeWAModal();

    const o = ordersCache.find(x => String(x.id) === String(id));
    if (!o) return closeWAModal();

    openWhatsAppWithText(o, $("waText").value);
    closeWAModal();
  }

  // =========================
  // Settings modal
  // =========================
  function openSettings(){
    const s = loadSettings();
    $("setShopName").value = s.shopName || "";
    $("setHours").value = s.hours || "";
    $("setSignature").value = s.signature || "";

    $("tplArrivee").value = s.templates.arrivee || "";
    $("tplRupture").value = s.templates.rupture || "";
    $("tplRelance").value = s.templates.relance || "";
    $("tplPartiel").value = s.templates.partiel || "";

    $("settingsBackdrop").style.display = "flex";
  }
  function closeSettings(){
    $("settingsBackdrop").style.display = "none";
  }
  function resetSettingsDefaults(){
    if (!confirm("R√©initialiser tous les param√®tres et templates WhatsApp ?")) return;
    saveSettingsToStorage(structuredClone(DEFAULT_SETTINGS));
    openSettings();
    applySettingsToUI(myStoreName || null);
  }
  function saveSettings(){
    const s = loadSettings();
    s.shopName = $("setShopName").value.trim() || DEFAULT_SETTINGS.shopName;
    s.hours = $("setHours").value.trim();
    s.signature = $("setSignature").value.trim() || DEFAULT_SETTINGS.signature;

    s.templates.arrivee = $("tplArrivee").value;
    s.templates.rupture = $("tplRupture").value;
    s.templates.relance = $("tplRelance").value;
    s.templates.partiel = $("tplPartiel").value;

    saveSettingsToStorage(s);
    applySettingsToUI(myStoreName || null);
    alert("‚úÖ Param√®tres enregistr√©s.");
    closeSettings();
  }

  function resetForm(){
    $("client").value = "";
    $("tel").value = "";
    $("article").value = "";
    $("qty").value = 1;
    $("notes").value = "";
    $("statut").value = "Mettre en commande";

    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    $("date").value = `${yyyy}-${mm}-${dd}`;

    setMsg("");
  }

  // =========================
  // Render
  // =========================
  function updateDashboard(activeList){
    let mec=0, com=0, rup=0, recu=0;
    for (const o of activeList){
      if (o.statut === "Mettre en commande") mec++;
      if (o.statut === "Commander") com++;
      if (o.statut === "Rupture de stock") rup++;
      if (Boolean(o.received_checked)) recu++;
    }
    $("statMEC").textContent = mec;
    $("statCOM").textContent = com;
    $("statRUP").textContent = rup;
    $("statRECU").textContent = recu;
  }

  function render(){
    const { active, history } = getActiveAndHistory(ordersCache);

    $("countActive").textContent = active.length;
    $("countHistory").textContent = history.length;
    updateDashboard(active);

    const q = ($("search").value || "").trim().toLowerCase();
    const filterStatus = $("filterStatus").value;

    const base = (currentView === "history") ? history : active;

    let list = base.filter(o=>{
      if(filterStatus && o.statut !== filterStatus) return false;
      if(!q) return true;
      return (
        (o.client || "").toLowerCase().includes(q) ||
        (o.tel || "").toLowerCase().includes(q) ||
        (o.article || "").toLowerCase().includes(q) ||
        (o.notes || "").toLowerCase().includes(q)
      );
    });

    if(currentView === "active"){
      list = [...list].sort((a,b) => (Boolean(b.received_checked) - Boolean(a.received_checked)));
    }

    $("countShown").textContent = list.length;

    const tbody = $("tbody");
    tbody.innerHTML = "";

    for(const o of list){
      const tr = document.createElement("tr");
      if(currentView === "active" && Boolean(o.received_checked)) tr.classList.add("row-received");

      const since = timeSince(o.created_at || o.createdAt);
      const receivedPill = (currentView === "active" && Boolean(o.received_checked))
        ? `<span class="pill receivedTag">RE√áU ‚úÖ</span>` : "";

      const receivedControl = (currentView === "active" && role === "shop")
        ? `<label class="cb"><input type="checkbox" ${Boolean(o.received_checked) ? "checked":""} data-action="received" data-id="${o.id}"> Re√ßu</label>`
        : `<span class="small">‚Äî</span>`;

      const actionsShop = (currentView === "active")
        ? `
          <div class="actions">
            ${receivedControl}
            <button class="ok" data-action="picked" data-id="${o.id}">Commande r√©cup√©r√©e</button>
            <button class="danger" data-action="delete" data-id="${o.id}">Supprimer</button>
          </div>
        `
        : `
          <div class="actions">
            <button class="danger" data-action="delete" data-id="${o.id}">Supprimer</button>
          </div>
        `;

      const actionsAdmin = `<div class="small">Lecture</div>`;

      tr.innerHTML = `
        <td>
          <span class="pill">${escapeHtml(o.date || "")}</span><br/>
          <span class="small">${escapeHtml(since)}</span><br/>
          ${receivedPill}
        </td>

        <td>
          <b>${escapeHtml(o.client || "")}</b><br/>
          <span class="small">${escapeHtml(o.tel || "")}</span><br/>
          <div class="small">Cr√©√©e par: <b>${escapeHtml(o.seller || "-")}</b></div>
        </td>

        <td>
          ${escapeHtml(o.article || "")}<br/>
          <span class="small">Qt√©: ${Number(o.qty || 1)} ‚Ä¢ Vendeur: ${escapeHtml(o.seller || "-")}</span>
        </td>

        <td>
          <span class="pill ${statusClass(o.statut)}">${escapeHtml(o.statut || "")}</span>
          <div style="margin-top:6px">
            <select ${role !== "shop" ? "disabled" : ""} data-action="status" data-id="${o.id}">
              ${["Mettre en commande","Commander","Rupture de stock","Re√ßu partiellement"].map(s => `
                <option ${o.statut===s ? "selected":""}>${escapeHtml(s)}</option>
              `).join("")}
            </select>
          </div>
        </td>

        <td>${escapeHtml(o.notes || "")}</td>

        <td>${role === "shop" ? actionsShop : actionsAdmin}</td>
      `;

      tbody.appendChild(tr);
    }
  }

  // =========================
  // Enter app (pr√©pare donn√©es) + va sur HUB
  // =========================
  function initUsers(){
    $("seller").innerHTML = USERS.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("");
    $("seller").value = USERS[0];
  }

  async function enterAfterLogin(email){
    // Pr√©pare l'app commandes (pour que quand on clique "Ouvrir", tout soit pr√™t)
    initUsers();
    setTodayDefault();
    resetForm();

    profile = await fetchProfile();
    role = profile.role || "shop";
    myStoreId = profile.store_id || null;

    await fetchStores();

    if(role === "admin"){
      // admin : pas de storeName fixe
      myStoreName = "Admin";
      $("uiSub").textContent = "ADMIN ‚Äì toutes boutiques";
      fillStoreSelect();
      // on ne charge PAS les commandes ici (on le fera quand on ouvre l'app)
    } else {
      if(!myStoreId){
        await ensureStoreId(email);
      }
      if(!myStoreId){
        throw new Error("Ton profil n‚Äôa pas de store_id (profiles.store_id) et aucun store ne correspond √† ton email.");
      }
      const s = storesCache.find(x => x.id === myStoreId);
      myStoreName = s?.name || "Boutique";
      $("uiSub").textContent = myStoreName;

      applySettingsToUI(myStoreName);
      // pas de loadOrders ici -> on charge √† l'ouverture de l'app commandes
    }

    // ‚úÖ Apr√®s login => HUB (menu apps)
    showHub(email);
  }

  // =========================
  // Reset password (EMAIL)
  // =========================
  async function sendReset(){
    try{
      setAuthMsg("");
      setAuthAlert("");

      const email = $("email").value.trim();
      if(!email){ setAuthAlert("‚ö†Ô∏è Mets l‚Äôemail puis clique ici."); return; }

      const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: SITE_URL + "/" });
      if(error){ setAuthAlert("‚ùå " + error.message); return; }

      setAuthMsg("‚úÖ Email de r√©initialisation envoy√©.");
    }catch(e){
      setAuthAlert("‚ùå " + (e?.message || e));
    }
  }

  // =========================
  // Actions HUB (NOUVEAU)
  // =========================
  async function openOrdersFromHub(){
    // Affiche app commandes + charge
    showOrdersApp();

    // Admin: montre adminCard + cache addCard
    if(role === "admin"){
      show($("adminCard"), true);
      show($("addCard"), false);
      // charge les commandes de la boutique s√©lectionn√©e
      await loadOrders();
    } else {
      show($("adminCard"), false);
      show($("addCard"), true);
      await loadOrders();
    }
  }

  function backToHub(){
    // Revenir menu apps sans se d√©connecter
    showHub($("userLabel").textContent);
  }

  // =========================
  // Events
  // =========================
  $("btnLogin").addEventListener("click", login);
  $("btnLogout").addEventListener("click", logout);
  $("btnReset").addEventListener("click", sendReset);
  $("btnUpdatePass").addEventListener("click", updatePassword);

  $("btnAdd").addEventListener("click", addOrder);
  $("btnClear").addEventListener("click", resetForm);

  $("btnSettings").addEventListener("click", openSettings);

  $("btnCloseSettings").addEventListener("click", closeSettings);
  $("btnResetSettings").addEventListener("click", resetSettingsDefaults);
  $("btnSaveSettings").addEventListener("click", saveSettings);

  $("btnCloseWA").addEventListener("click", closeWAModal);
  $("btnCancelWA").addEventListener("click", closeWAModal);
  $("btnResetWA").addEventListener("click", applySelectedTemplate);
  $("btnCopyWA").addEventListener("click", copyWAText);
  $("btnOpenWA").addEventListener("click", confirmOpenWhatsApp);
  $("waTemplate").addEventListener("change", applySelectedTemplate);

  $("waBackdrop").addEventListener("click", closeWAModal);
  $("settingsBackdrop").addEventListener("click", closeSettings);

  $("tabActive").addEventListener("click", ()=>{ currentView="active"; $("tabActive").classList.add("active"); $("tabHistory").classList.remove("active"); render(); });
  $("tabHistory").addEventListener("click", ()=>{ currentView="history"; $("tabHistory").classList.add("active"); $("tabActive").classList.remove("active"); render(); });

  $("search").addEventListener("input", render);
  $("filterStatus").addEventListener("change", render);

  $("btnReloadAdmin").addEventListener("click", loadOrders);
  $("storeSelect").addEventListener("change", loadOrders);

  // Delegation actions table
  $("tbody").addEventListener("change", async (e)=>{
    const el = e.target;
    const action = el?.dataset?.action;
    const id = el?.dataset?.id;
    if(action === "status"){
      await updateStatus(id, el.value);
    }
  });

  $("tbody").addEventListener("click", async (e)=>{
    const el = e.target;
    const action = el?.dataset?.action;
    const id = el?.dataset?.id;

    if(action === "picked") await markPickedUp(id);
    if(action === "delete") await deleteOrder(id);
  });

  $("tbody").addEventListener("change", async (e)=>{
    const el = e.target;
    if(el?.dataset?.action === "received"){
      await toggleReceived(el.dataset.id);
    }
  });

  // ESC ferme les modals
  document.addEventListener("keydown", (e)=>{
    if (e.key !== "Escape") return;
    if ($("waBackdrop").style.display === "flex") closeWAModal();
    if ($("settingsBackdrop").style.display === "flex") closeSettings();
  });

  // Debug global erreurs
  window.addEventListener("error", (e) => setDebug("JS error: " + (e.message || "inconnue")));
  window.addEventListener("unhandledrejection", (e) => setDebug("Promise error: " + (e.reason?.message || e.reason || "inconnue")));

  // ===== HUB buttons =====
  $("btnOpenOrders")?.addEventListener("click", openOrdersFromHub);
  $("btnBackToHub")?.addEventListener("click", backToHub);
  // placeholder app2
  $("btnOpenApp2")?.addEventListener("click", ()=> alert("‚ú® Cette application arrive bient√¥t !"));

  // =========================
  // Auth listener + boot
  // =========================
  supabaseClient.auth.onAuthStateChange(async (_event, session) => {
    if (isLoggingOut) return;

    const user = session?.user;

    // ‚úÖ si on est sur un lien de recovery => on affiche le reset, pas de redirection
    if (isRecoveryFlow()) {
      showLogin();
      show($("resetCard"), true);
      allowAutoLogin = false;
      return;
    }

    if (!user) {
      showLogin();
      return;
    }

    if (!allowAutoLogin) {
      showLogin();
      return;
    }

    if (hasBooted) return;
    hasBooted = true;

    try{
      await enterAfterLogin(user.email || "connect√©");
    }catch(err){
      console.error(err);
      alert("‚ùå " + (err?.message || err));
      showLogin();
      hasBooted = false;
    }
  });

  (async ()=>{
    // ‚úÖ recovery: on reste sur l‚Äô√©cran de reset
    if(isRecoveryFlow()){
      showLogin();
      show($("resetCard"), true);
      return;
    }

    const { data } = await supabaseClient.auth.getSession();

    if (isLoggingOut) { showLogin(); return; }

    if (data?.session?.user) {
      if (!allowAutoLogin) { showLogin(); return; }
      if (!hasBooted) {
        hasBooted = true;
        try{
          await enterAfterLogin(data.session.user.email || "connect√©");
        }catch(err){
          console.error(err);
          alert("‚ùå " + (err?.message || err));
          showLogin();
          hasBooted = false;
        }
      }
    } else {
      showLogin();
    }
  })();

})();
</script>
