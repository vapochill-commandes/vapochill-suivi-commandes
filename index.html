<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Vapo'Chill ‚Äì Suivi commandes</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#06080d;
      --bg1:#0a0f1a;

      --cardA: rgba(11,18,32,.70);
      --cardB: rgba(11,18,32,.52);

      --text:#eaf0ff;
      --muted:#9fb0d2;

      --border:rgba(150, 190, 255, .18);

      --neonA:#4a7dff; /* blue */
      --neonB:#2bb673; /* green */
      --neonC:#b9a7ff; /* violet */

      --danger:#ff4d6d;
      --warning:#f6c453;
    }

    *{ box-sizing:border-box; }
    html, body { height:100%; }

    body{
      margin:0;
      font-family: Inter, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1000px 500px at 15% 10%, rgba(74,125,255,.18), transparent 55%),
        radial-gradient(900px 520px at 85% 20%, rgba(43,182,115,.14), transparent 60%),
        radial-gradient(800px 540px at 55% 90%, rgba(185,167,255,.12), transparent 60%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Neon grid overlay */
    body:before{
      content:"";
      position:fixed; inset:-2px;
      background:
        linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity:.10;
      transform: perspective(900px) rotateX(55deg) translateY(-180px);
      transform-origin: top;
      pointer-events:none;
      filter: blur(.2px);
    }

    /* scanline */
    body:after{
      content:"";
      position:fixed; inset:0;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.04),
        rgba(255,255,255,.04) 1px,
        transparent 1px,
        transparent 6px
      );
      opacity:.04;
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .wrap{
      padding: 92px 18px 18px;
      max-width: 1280px;
      margin: 0 auto;
    }
    .hidden{ display:none !important; }

    /* ===== TOP BAR ===== */
    .topbar{
      position:fixed; top:0; left:0; right:0;
      height:68px;
      display:flex; align-items:center; justify-content:space-between;
      padding:0 18px;
      z-index:1000;
      background: rgba(7, 10, 16, .72);
      border-bottom: 1px solid rgba(150,190,255,.12);
      backdrop-filter: blur(14px);
      box-shadow: 0 18px 55px rgba(0,0,0,.35);
      gap:10px;
    }
    .topbar-left{ display:flex; align-items:center; gap:12px; }
    .topbar img{
      height:42px;
      border-radius:12px;
      padding:4px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(150,190,255,.14);
    }
    .topbar-title{ display:flex; flex-direction:column; line-height:1.1; }
    .topbar-title b{
      font-size:13px;
      letter-spacing:.3px;
    }
    .topbar-title span{
      font-size:12px;
      opacity:.9;
      color: var(--muted);
    }
    .topbar-right{
      display:flex; gap:10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .chip{
      border:1px solid rgba(150, 190, 255, .16);
      border-radius:999px;
      padding:7px 10px;
      display:flex; align-items:center; gap:8px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
      white-space:nowrap;
      backdrop-filter: blur(10px);
    }

    /* Buttons */
    button{
      border:0;
      cursor:pointer;
      font-weight:700;
      font-family:inherit;
      letter-spacing:.2px;
    }
    .btn{
      padding:10px 12px;
      border-radius:14px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(150,190,255,.16);
      color: var(--text);
      transition: transform .12s ease, filter .12s ease, background .12s ease;
      backdrop-filter: blur(12px);
    }
    .btn:hover{ filter: brightness(1.08); }
    .btn:active{ transform: translateY(1px); }

    .btnPrimary{
      padding:11px 14px;
      border-radius:14px;
      color:#061018;
      background: linear-gradient(135deg, rgba(74,125,255,1), rgba(43,182,115,1));
      box-shadow:
        0 0 0 1px rgba(150,190,255,.12),
        0 10px 32px rgba(74,125,255,.20),
        0 10px 32px rgba(43,182,115,.14);
      transition: transform .12s ease, filter .12s ease;
    }
    .btnPrimary:hover{ filter: brightness(1.04); }
    .btnPrimary:active{ transform: translateY(1px); }

    .btnDanger{
      background: rgba(255, 77, 109, .18);
      border:1px solid rgba(255, 77, 109, .35);
      color: #ffd7de;
    }

    /* Cards */
    .card{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid rgba(150,190,255,.16);
      border-radius: 20px;
      padding: 16px;
      margin: 12px 0;
      box-shadow:
        0 0 0 1px rgba(255,255,255,.04) inset,
        0 24px 80px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .card:before{
      content:"";
      position:absolute;
      inset:-60px -80px auto auto;
      width:260px; height:260px;
      background: radial-gradient(circle, rgba(74,125,255,.22), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }
    .card h2{
      margin:0 0 6px;
      font-size:18px;
      letter-spacing:.2px;
    }
    .small{
      font-size:12px;
      color: var(--muted);
      white-space:pre-wrap;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }

    label{
      font-size:12px;
      color: rgba(234,240,255,.75);
      display:block;
      margin-bottom:6px;
    }

    /* Inputs */
    input, select, textarea{
      width: 240px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(150,190,255,.18);
      background: rgba(255,255,255,.05);
      color: var(--text);
      outline: none;
      transition: border-color .12s ease, box-shadow .12s ease, filter .12s ease;
      box-shadow: 0 0 0 1px rgba(255,255,255,.03) inset;
      font-family: inherit;
    }
    input::placeholder, textarea::placeholder{ color: rgba(159,176,210,.7); }
    input:focus, select:focus, textarea:focus{
      border-color: rgba(74,125,255,.55);
      box-shadow: 0 0 0 4px rgba(74,125,255,.14);
    }
    textarea{ width: 520px; height: 70px; }

    /* Login layout */
    .loginGrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:stretch;
    }
    .loginRight{
      border-radius:18px;
      border:1px solid rgba(150,190,255,.12);
      background: rgba(255,255,255,.04);
      padding: 14px;
      position:relative;
      overflow:hidden;
    }
    .loginRight:before{
      content:"";
      position:absolute; inset:-40px -40px auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle, rgba(43,182,115,.20), transparent 60%);
      pointer-events:none;
    }
    .kpiLine{
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(150,190,255,.10);
      background: rgba(255,255,255,.04);
      margin-top:10px;
    }
    .kpiLine b{ font-size:12px; color: rgba(234,240,255,.85); }
    .kpiLine span{ font-size:12px; color: var(--muted); }

    .statusDot{
      width:10px; height:10px;
      border-radius:999px;
      background: radial-gradient(circle, rgba(74,125,255,1), rgba(74,125,255,.15));
      box-shadow: 0 0 12px rgba(74,125,255,.35);
      display:inline-block;
      margin-right:8px;
    }

    /* Table */
    table { width:100%; border-collapse: collapse; margin-top: 8px; }
    th, td { border-bottom:1px solid rgba(150,190,255,.10); padding:10px; text-align:left; vertical-align: top; }
    th { font-size: 12px; color: rgba(234,240,255,.75); }

    .pill{
      display:inline-block;
      padding:5px 10px;
      border-radius:999px;
      font-size:12px;
      border:1px solid rgba(150,190,255,.16);
      background: rgba(255,255,255,.05);
      color: rgba(234,240,255,.88);
    }

    /* Status pills */
    .st { font-weight: 900; letter-spacing:.15px; }
    .st-mec { border-color:rgba(246,196,83,.35); background:rgba(246,196,83,.12); color:#ffe9b6; }
    .st-com { border-color:rgba(74,125,255,.35); background:rgba(74,125,255,.12); color:#d6e2ff; }
    .st-rup { border-color:rgba(255,77,109,.35); background:rgba(255,77,109,.12); color:#ffd1db; }
    .st-par { border-color:rgba(185,167,255,.35); background:rgba(185,167,255,.12); color:#efe9ff; }

    .receivedTag{
      border-color: rgba(43,182,115,.35);
      background: rgba(43,182,115,.12);
      font-weight: 900;
      color:#d9ffe9;
    }

    .tabs { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .tab{
      padding:9px 11px;
      border-radius:999px;
      border:1px solid rgba(150,190,255,.14);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      font-size:12px;
      user-select:none;
      color: rgba(234,240,255,.80);
    }
    .tab.active{
      background: linear-gradient(135deg, rgba(74,125,255,.25), rgba(43,182,115,.18));
      border-color: rgba(74,125,255,.38);
      color: #eaf0ff;
      box-shadow: 0 0 26px rgba(74,125,255,.10);
    }
    .right{ margin-left:auto; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .cb{ display:flex; align-items:center; gap:8px; font-size:12px; color: rgba(234,240,255,.78); user-select:none; }
    .cb input{ width:auto; transform: scale(1.15); }

    /* Dashboard */
    .dashboard{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
      gap:12px;
      margin: 12px 0;
    }
    .statCard{
      background: linear-gradient(180deg, var(--cardA), var(--cardB));
      border:1px solid rgba(150,190,255,.14);
      border-radius:18px;
      padding:14px;
      box-shadow: 0 18px 60px rgba(0,0,0,.38);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      backdrop-filter: blur(14px);
    }
    .statCard .label{
      font-size:12px;
      color: var(--muted);
      font-weight:800;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .statCard .value{ font-size:22px; font-weight:900; letter-spacing:.3px; }
    .dot{ width:10px; height:10px; border-radius:50%; }
    .dot.mec{ background: var(--warning); }
    .dot.com{ background: var(--neonA); }
    .dot.rup{ background: var(--danger); }
    .dot.recu{ background: var(--neonB); }

    /* Modals */
    .modalBackdrop{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:2000;
      padding:16px;
      backdrop-filter: blur(8px);
    }
    .modal{
      width:min(860px, 100%);
      background: linear-gradient(180deg, rgba(11,18,32,.88), rgba(11,18,32,.72));
      border-radius:20px;
      border:1px solid rgba(150,190,255,.18);
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      background: rgba(255,255,255,.04);
      border-bottom:1px solid rgba(150,190,255,.14);
      padding:14px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader b{ font-size:14px; }
    .modalBody{ padding:14px 16px; }
    .modalFooter{
      padding:14px 16px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:space-between;
      border-top:1px solid rgba(150,190,255,.14);
      background: rgba(255,255,255,.02);
      align-items:center;
    }
    .waBox{
      border:1px solid rgba(150,190,255,.16);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
      white-space:pre-wrap;
      font-size:13px;
      line-height:1.45;
      width:100%;
      min-height: 220px;
      resize:vertical;
      font-family: inherit;
      color: var(--text);
      outline:none;
    }
    .toggleRow{
      display:flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      font-size:12px;
      color: rgba(234,240,255,.78);
    }
    .toggleRow input{ transform: scale(1.15); }

    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .field input, .field textarea, .field select{ width:100%; }

    @media (max-width: 900px){
      .grid2{ grid-template-columns:1fr; }
      .loginGrid{ grid-template-columns: 1fr; }
    }
    @media (max-width: 700px){
      input, select, textarea { width: 100%; }
      textarea { width: 100%; }
      .topbar-right { gap:6px; }
    }
  </style>
</head>

<body>
  <!-- TOP BAR -->
  <div class="topbar">
    <div class="topbar-left">
      <img src="./logo-vapochill.jpeg" alt="Vapo'Chill" onerror="this.style.display='none'">
      <div class="topbar-title">
        <b id="uiTitle">Vapo'Chill ‚Äì Connexion</b>
        <span id="uiSub">‚Äî</span>
      </div>
    </div>

    <div class="topbar-right">
      <button class="btn hidden" style="padding:9px 11px;border-radius:999px" id="btnSettings" type="button">‚öôÔ∏è Param√®tres</button>
      <div class="chip">üïí <span id="clock">--:--</span></div>
      <div class="chip">üë§ <span id="userLabel">non connect√©</span></div>
      <button class="btn btnDanger hidden" style="padding:9px 11px;border-radius:999px" id="btnLogout" type="button">D√©connexion</button>
    </div>
  </div>

  <div class="wrap">

    <!-- ====== LOGIN ====== -->
    <div class="card" id="loginCard">
      <div class="loginGrid">

        <div>
          <h2>Connexion</h2>
          <div class="small">Interface s√©curis√©e ‚Äî acc√®s boutique / admin.</div>
          <div style="height:12px"></div>

          <div class="row">
            <div>
              <label>Email</label>
              <input id="email" placeholder="boutique.toursnord@vapochill.fr" autocomplete="username">
            </div>
            <div>
              <label>Mot de passe</label>
              <input id="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
            </div>
            <button id="btnLogin" class="btnPrimary" type="button">Se connecter</button>
          </div>

          <div class="row" style="margin-top:10px; align-items:center;">
            <button class="btn" id="btnReset" type="button">Mot de passe oubli√©</button>
            <span class="small" id="authMsg"></span>
          </div>

          <div class="card hidden" style="margin-top:12px" id="debugCard">
            <b style="font-size:13px;">Debug</b>
            <div class="small" id="debug">‚Äî</div>
          </div>

          <div class="card hidden" id="resetCard" style="margin-top:12px">
            <b>üîí D√©finir un nouveau mot de passe</b>
            <div class="small" style="margin-top:6px">Ce bloc s‚Äôaffiche quand tu arrives via un lien de r√©cup√©ration.</div>
            <div style="height:10px"></div>
            <label>Nouveau mot de passe</label>
            <input id="newPassword" type="password" style="width:100%" placeholder="Nouveau mot de passe">
            <div class="row" style="margin-top:10px; align-items:center;">
              <button class="btnPrimary" id="btnUpdatePass" type="button">Enregistrer</button>
              <span class="small" id="resetMsg"></span>
            </div>
          </div>
        </div>

        <div class="loginRight">
          <div class="small" style="margin-bottom:8px;">
            <span class="statusDot"></span><b style="color:rgba(234,240,255,.85)">Secure Mode</b>
            <div style="margin-top:6px;">Connexion chiffr√©e ‚Ä¢ Session Supabase</div>
          </div>

          <div class="kpiLine"><b>Statut syst√®me</b><span>online</span></div>
          <div class="kpiLine"><b>Acc√®s</b><span>Boutique / Admin</span></div>
          <div class="kpiLine"><b>Version UI</b><span>Neon Grid</span></div>

          <div class="small" style="margin-top:12px; opacity:.85;">
            Astuce : utilise la recherche pour retrouver un client en 1 seconde.
          </div>
        </div>

      </div>
    </div>
    <!-- ====== APP ====== -->
    <div class="hidden" id="appRoot">

      <!-- ADMIN : select boutique -->
      <div class="card hidden" id="adminCard">
        <div class="row" style="justify-content:space-between; align-items:end;">
          <div>
            <b>Mode admin</b>
            <div class="small">Choisis une boutique pour afficher ses commandes.</div>
          </div>
          <div class="row">
            <div>
              <label>Boutique</label>
              <select id="storeSelect" style="width:320px"></select>
            </div>
            <button class="btn" id="btnReloadAdmin" type="button">Recharger</button>
          </div>
        </div>
      </div>

      <!-- DASHBOARD -->
      <div class="dashboard">
        <div class="statCard">
          <div>
            <div class="label"><span class="dot mec"></span> Mettre en commande</div>
            <div class="value" id="statMEC">0</div>
          </div>
          <div class="pill st st-mec">En attente</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot com"></span> Commander</div>
            <div class="value" id="statCOM">0</div>
          </div>
          <div class="pill st st-com">Command√©e</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot rup"></span> Rupture de stock</div>
            <div class="value" id="statRUP">0</div>
          </div>
          <div class="pill st st-rup">Rupture</div>
        </div>

        <div class="statCard">
          <div>
            <div class="label"><span class="dot recu"></span> Re√ßu (coch√©)</div>
            <div class="value" id="statRECU">0</div>
          </div>
          <div class="pill receivedTag">Re√ßu ‚úÖ</div>
        </div>
      </div>

      <!-- ADD ORDER -->
      <div class="card" id="addCard">
        <b>Ajouter une commande</b>

        <div class="row" style="margin-top:10px">
          <div>
            <label>Client</label>
            <input id="client" placeholder="Nom client">
          </div>
          <div>
            <label>Num√©ro</label>
            <input id="tel" placeholder="06 12 34 56 78">
          </div>
          <div>
            <label>Article</label>
            <input id="article" placeholder="Article command√©">
          </div>
          <div>
            <label>Quantit√©</label>
            <input id="qty" type="number" min="1" value="1">
          </div>
          <div>
            <label>Date</label>
            <input id="date" type="date">
          </div>
          <div>
            <label>Statut</label>
            <select id="statut">
              <option>Mettre en commande</option>
              <option>Commander</option>
              <option>Rupture de stock</option>
              <option>Re√ßu partiellement</option>
            </select>
          </div>
          <div>
            <label>Vendeur</label>
            <select id="seller"></select>
          </div>
        </div>

        <div class="row" style="margin-top:8px">
          <div>
            <label>Notes</label>
            <textarea id="notes" placeholder="Notes internes"></textarea>
          </div>
        </div>

        <div class="row" style="margin-top:8px; align-items:center;">
          <button id="btnAdd" class="btnPrimary" type="button">Ajouter</button>
          <button id="btnClear" class="btn" type="button">Vider</button>
          <span class="small" id="msg"></span>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card">
        <div class="row" style="align-items:center; justify-content:space-between;">
          <div>
            <b>Commandes</b>
            <div class="small">Gestion des commandes en cours et archiv√©es.</div>
          </div>

          <div class="row" style="gap:8px">
            <input id="search" placeholder="Rechercher..." style="width:220px">
            <select id="filterStatus" style="width:180px">
              <option value="">Tous statuts</option>
              <option>Mettre en commande</option>
              <option>Commander</option>
              <option>Rupture de stock</option>
              <option>Re√ßu partiellement</option>
            </select>
            <select id="antiError">
              <option value="on">Anti-erreur: ON</option>
              <option value="off">Anti-erreur: OFF</option>
            </select>
          </div>
        </div>

        <div class="tabs">
          <div class="tab active" id="tabActive">En cours (<span id="countActive">0</span>)</div>
          <div class="tab" id="tabHistory">Historique (<span id="countHistory">0</span>)</div>
          <div class="tab right">Affich√©es: <b id="countShown">0</b></div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Date</th>
              <th>Client</th>
              <th>Article</th>
              <th>Statut</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div> <!-- /appRoot -->

    <!-- ====== WHATSAPP MODAL ====== -->
    <div class="modalBackdrop" id="waBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalHeader">
          <b>WhatsApp ‚Äì Pr√©parer le message</b>
          <button class="btn" id="btnCloseWA" type="button">‚úñ</button>
        </div>

        <div class="modalBody">
          <div class="small" id="waMeta"></div>
          <div style="height:8px"></div>

          <label>Template</label>
          <select id="waTemplate" style="width:100%">
            <option value="arrivee">‚úÖ Arriv√©e boutique</option>
            <option value="rupture">‚ùå Rupture / d√©lai</option>
            <option value="relance">‚è≥ Relance fournisseur</option>
            <option value="partiel">üì¶ Re√ßu partiellement</option>
          </select>

          <div style="height:8px"></div>

          <label>Message</label>
          <textarea id="waText" class="waBox"></textarea>

          <div class="toggleRow">
            <input id="waNoPreview" type="checkbox">
            <span>Ouvrir directement WhatsApp sans pr√©visualisation</span>
          </div>
        </div>

        <div class="modalFooter">
          <div class="actions">
            <button class="btn" id="btnCancelWA" type="button">Annuler</button>
            <button class="btn" id="btnResetWA" type="button">R√©initialiser</button>
            <button class="btn" id="btnCopyWA" type="button">Copier</button>
          </div>
          <div class="actions">
            <button class="btnPrimary" id="btnOpenWA" type="button">Ouvrir WhatsApp</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ====== SETTINGS MODAL ====== -->
    <div class="modalBackdrop" id="settingsBackdrop">
      <div class="modal" onclick="event.stopPropagation()">
        <div class="modalHeader">
          <b>Param√®tres WhatsApp</b>
          <button class="btn" id="btnCloseSettings" type="button">‚úñ</button>
        </div>

        <div class="modalBody">
          <div class="row" style="align-items:end">
            <div class="field">
              <label>Nom boutique</label>
              <input id="setShopName" placeholder="Vapo'Chill">
            </div>
            <div class="field">
              <label>Horaires (optionnel, ajout√© dans la signature)</label>
              <input id="setHours" placeholder="Ex: Lun-Sam 10h-19h">
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="field">
            <label>Signature (utilise {vendeur})</label>
            <input id="setSignature" placeholder="{vendeur} - Vapochill">
            <div class="small">Ex: <b>{vendeur} - Vapo'Chill</b> ou juste <b>Vapo'Chill</b></div>
          </div>

          <div style="height:14px"></div>

          <b style="font-size:13px;">Templates WhatsApp</b>
          <div class="small">Variables : <b>{article}</b> <b>{client}</b> <b>{vendeur}</b> <b>{boutique}</b> <b>{horaires}</b></div>

          <div style="height:10px"></div>

          <div class="grid2">
            <div class="field">
              <label>‚úÖ Arriv√©e boutique</label>
              <textarea id="tplArrivee" class="waBox" style="min-height:150px"></textarea>
            </div>
            <div class="field">
              <label>‚ùå Rupture / d√©lai</label>
              <textarea id="tplRupture" class="waBox" style="min-height:150px"></textarea>
            </div>
            <div class="field">
              <label>‚è≥ Relance fournisseur</label>
              <textarea id="tplRelance" class="waBox" style="min-height:150px"></textarea>
            </div>
            <div class="field">
              <label>üì¶ Re√ßu partiellement</label>
              <textarea id="tplPartiel" class="waBox" style="min-height:150px"></textarea>
            </div>
          </div>
        </div>

        <div class="modalFooter">
          <div class="small">Les param√®tres WhatsApp sont sauvegard√©s sur ce PC (localStorage).</div>
          <div class="actions">
            <button class="btn" id="btnResetSettings" type="button">R√©initialiser</button>
            <button class="btnPrimary" id="btnSaveSettings" type="button">Enregistrer</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Supabase v2 -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script nomodule>
      document.body.innerHTML = `
        <div style="padding:24px;font-family:Inter,Arial,sans-serif;color:#eaf0ff;background:#06080d;">
          <h2>Votre navigateur est trop ancien</h2>
          <p>Cette page utilise des fonctionnalit√©s modernes (async/await). Merci de mettre √† jour votre navigateur.</p>
        </div>
      `;
    </script>

    <script type="module">
    (async function(){
      // =========================
      // Helpers
      // =========================
      const $ = (id)=>document.getElementById(id);
      const show = (el, yes)=> el.classList.toggle("hidden", !yes);

      const setAuthMsg = (t)=> { $("authMsg").textContent = t || ""; };
      const setResetMsg = (t)=> { $("resetMsg").textContent = t || ""; };
      const setMsg = (t)=> { $("msg").textContent = t || ""; };

      // ‚úÖ setDebug ne plante plus si #debug n'existe pas
      const setDebug = (t)=> {
        const el = $("debug");
        if (el) el.textContent = t || "";
        // Affiche le bloc debug uniquement si du texte
        const card = $("debugCard");
        if (card) show(card, Boolean(t && String(t).trim()));
      };

      function canWrite(){
        return role === "shop" || role === "admin";
      }

      function escapeHtml(s) {
        return (s || "")
          .replaceAll("&","&amp;")
          .replaceAll("<","&lt;")
          .replaceAll(">","&gt;")
          .replaceAll('"',"&quot;");
      }

      // =========================
      // Recovery flow
      // =========================
      function isRecoveryFlow(){
        const h=(location.hash||"").toLowerCase();
        const q=(location.search||"").toLowerCase();
        return h.includes("access_token=") || q.includes("type=recovery") || q.includes("recovery");
      }

      // =========================
      // Supabase config
      // =========================
      const SUPABASE_URL = "https://lhddwfeaoxnlflqlihdg.supabase.co";
      const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZGR3ZmVhb3hubGZscWxpaGRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc2MTI0NjcsImV4cCI6MjA4MzE4ODQ2N30.5Po48JdTbLZhcXjyJ48Il511DpiYNPdUZq4H-HNPAa4";
      const SITE_URL = "https://beck37360.github.io/vapochill-suivi-commandes";

      async function loadSupabaseScript(src){
        return new Promise((resolve, reject) => {
          const script = document.createElement("script");
          script.src = src;
          script.async = true;
          script.onload = () => resolve();
          script.onerror = () => reject(new Error("load failed: " + src));
          document.head.appendChild(script);
        });
      }

      async function ensureSupabaseLoaded(){
        if (window.supabase?.createClient) return true;
        try{ await loadSupabaseScript("https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"); }catch(e){ console.warn(e); }
        if (window.supabase?.createClient) return true;
        try{ await loadSupabaseScript("https://unpkg.com/@supabase/supabase-js@2"); }catch(e){ console.warn(e); }
        return Boolean(window.supabase?.createClient);
      }

      const supabaseReady = await ensureSupabaseLoaded();
      if(!supabaseReady){
        alert("‚ùå La librairie Supabase ne charge pas (CDN bloqu√© / r√©seau).");
        setAuthMsg("‚ùå Supabase indisponible. V√©rifie la connexion ou le bloqueur de pub.");
        return;
      }

      const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      window.supabaseClient = supabaseClient;

      // ‚úÖ Flags
      let isLoggingOut = false;
      let hasBooted = false;
      let allowAutoLogin = false;

      // =========================
      // App config
      // =========================
      const USERS = ["Laetitia","Marco","Charlotte","Nico","Alan","Corentin","Mathieu","Romain"];

      // WhatsApp modal mode
      const WA_PREVIEW_KEY = "wa_preview_mode_v1"; // "direct" ou "preview"
      if (!localStorage.getItem(WA_PREVIEW_KEY)) localStorage.setItem(WA_PREVIEW_KEY, "preview");

      // Settings
      const SETTINGS_KEY = "vc_settings_v1";

      const DEFAULT_SETTINGS = {
        shopName: "Vapo'Chill",
        hours: "",
        signature: "{vendeur} - Vapochill",
        templates: {
          arrivee:
`Bonjour,

Votre commande {article} est bien arriv√©e en boutique
Vous pouvez passer quand vous voulez

{signature}`,
          rupture:
`Bonjour,

Petit retour pour votre commande {article} : elle est en rupture chez le fournisseur.
Je vous tiens au courant d√®s que j‚Äôai une date

{signature}`,
          relance:
`Bonjour,

Je reviens vers vous : votre commande {article} est toujours en attente.
On relance le fournisseur et on vous tient inform√©

{signature}`,
          partiel:
`Bonjour,

Une partie de votre commande {article} est arriv√©e en boutique
Je vous confirme le reste d√®s r√©ception

{signature}`
        }
      };

      function loadSettings(){
        try{
          const raw = localStorage.getItem(SETTINGS_KEY);
          if (!raw) return structuredClone(DEFAULT_SETTINGS);
          const obj = JSON.parse(raw);
          return {
            ...structuredClone(DEFAULT_SETTINGS),
            ...obj,
            templates: { ...structuredClone(DEFAULT_SETTINGS.templates), ...(obj.templates || {}) }
          };
        }catch{
          return structuredClone(DEFAULT_SETTINGS);
        }
      }
      function saveSettingsToStorage(settings){
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
      }
      function applySettingsToUI(shopNameOverride){
        const s = loadSettings();
        const name = shopNameOverride || s.shopName || "Vapo'Chill";
        $("uiTitle").textContent = `${name} ‚Äì Suivi commandes`;
      }

      // =========================
      // Clock
      // =========================
      function tickClock(){
        const d = new Date();
        const hh = String(d.getHours()).padStart(2,"0");
        const mm = String(d.getMinutes()).padStart(2,"0");
        $("clock").textContent = `${hh}:${mm}`;
      }
      setInterval(tickClock, 1000);
      tickClock();

      // =========================
      // State
      // =========================
      let currentView = "active";
      let role = null;        // "admin" | "shop"
      let profile = null;     // profiles row
      let myStoreId = null;
      let myStoreName = null;
      let storesCache = [];
      let ordersCache = [];
      let waPendingOrderId = null;

      // =========================
      // UI: login/app
      // =========================
      function showLogin(){
        $("uiTitle").textContent = "Vapo'Chill ‚Äì Connexion";
        $("uiSub").textContent = "‚Äî";
        $("userLabel").textContent = "non connect√©";

        show($("btnLogout"), false);
        show($("btnSettings"), false);

        show($("loginCard"), true);
        show($("appRoot"), false);

        // ‚úÖ affiche resetCard uniquement si recovery
        show($("resetCard"), isRecoveryFlow());

        setAuthMsg("");
        setResetMsg("");
        setMsg("");
        setDebug("");

        hasBooted = false;
      }

      function showApp(email){
        show($("loginCard"), false);
        show($("appRoot"), true);
        show($("btnLogout"), true);
        show($("btnSettings"), true);
        $("userLabel").textContent = email || "connect√©";
      }

      // =========================
      // Auth actions
      // =========================
      async function login(){
        try{
          setAuthMsg("");
          const email = $("email").value.trim();
          const password = $("password").value.trim();
          if(!email || !password){ setAuthMsg("‚ö†Ô∏è Mets email + mot de passe."); return; }

          setAuthMsg("‚è≥ Connexion‚Ä¶");
          allowAutoLogin = true;

          const { error } = await supabaseClient.auth.signInWithPassword({ email, password });
          if(error){ setAuthMsg("‚ùå " + error.message); return; }

          setAuthMsg("‚úÖ Connect√©.");
        }catch(e){
          setAuthMsg("‚ùå " + (e?.message || e));
        }
      }

      async function logout(){
        try{
          isLoggingOut = true;
          hasBooted = false;
          allowAutoLogin = false;
          await supabaseClient.auth.signOut({ scope: "local" });
        } catch (e) {
          console.warn("signOut error (ignored):", e);
        } finally {
          // purge tokens
          for (const k of Object.keys(localStorage)) {
            if (k.startsWith("sb-") && k.includes("auth")) localStorage.removeItem(k);
          }
          for (const k of Object.keys(sessionStorage)) {
            if (k.startsWith("sb-") && k.includes("auth")) sessionStorage.removeItem(k);
          }
          showLogin();
          setTimeout(()=>{ isLoggingOut = false; }, 1200);
        }
      }

      async function updatePassword(){
        try{
          setResetMsg("");
          const pass = $("newPassword").value.trim();
          if(pass.length < 6){ setResetMsg("‚ö†Ô∏è Min 6 caract√®res."); return; }

          const { error } = await supabaseClient.auth.updateUser({ password: pass });
          if(error){ setResetMsg("‚ùå " + error.message); return; }

          setResetMsg("‚úÖ Mot de passe modifi√©. Reconnecte-toi.");
        }catch(e){
          setResetMsg("‚ùå " + (e?.message || e));
        }
      }

      // =========================
      // Data helpers
      // =========================
      function statusClass(statut) {
        if (statut === "Mettre en commande") return "st st-mec";
        if (statut === "Commander") return "st st-com";
        if (statut === "Rupture de stock") return "st st-rup";
        if (statut === "Re√ßu partiellement") return "st st-par";
        return "st";
      }

      function setTodayDefault() {
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("date").value = `${yyyy}-${mm}-${dd}`;
      }

      function timeSince(iso) {
        const d = new Date(iso);
        if (isNaN(d.getTime())) return "";
        let diff = Math.max(0, Date.now() - d.getTime());
        const min = Math.floor(diff / 60000);
        const h = Math.floor(min / 60);
        const m = min % 60;
        const j = Math.floor(h / 24);
        const hh = h % 24;
        if (j > 0) return `il y a ${j}j ${hh}h`;
        if (h > 0) return `il y a ${h}h ${m}m`;
        return `il y a ${m}m`;
      }

      function phoneToWhatsAppNumber(phone) {
        let p = (phone || "").replace(/[^\d+]/g, "");
        p = p.replace(/\D/g, "");
        if (!p) return "";
        if (p.startsWith("0") && p.length === 10) return "33" + p.slice(1);
        if (p.startsWith("33")) return p;
        if (p.startsWith("0033")) return "33" + p.slice(4);
        return p;
      }

      function antiErrorOn(){
        return $("antiError")?.value === "on";
      }

      function isUuid(value){
        return /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(value || "");
      }

      function getWAPreviewMode(){
        return localStorage.getItem(WA_PREVIEW_KEY) || "preview";
      }
      function setWAPreviewMode(mode){
        localStorage.setItem(WA_PREVIEW_KEY, mode);
      }

      function templateToMessage(template, order){
        const s = loadSettings();
        const shop = myStoreName || s.shopName || "Vapo'Chill";
        const hours = s.hours || "";
        const vendeur = ($("seller")?.value || "").trim();

        const signature = (s.signature || "{vendeur} - Vapochill")
          .replaceAll("{vendeur}", vendeur)
          .replaceAll("{boutique}", shop)
          .replaceAll("{horaires}", hours);

        return (template || "")
          .replaceAll("{article}", order.article || "votre commande")
          .replaceAll("{client}", order.client || "")
          .replaceAll("{vendeur}", vendeur)
          .replaceAll("{boutique}", shop)
          .replaceAll("{horaires}", hours)
          .replaceAll("{signature}", signature);
      }

      function getTemplateByKey(key){
        const s = loadSettings();
        const t = s.templates || {};
        return t[key] || "";
      }

      function openWhatsAppWithText(order, customText) {
        const num = phoneToWhatsAppNumber(order.tel);
        if (!num) { alert("‚ö†Ô∏è Num√©ro invalide pour WhatsApp."); return; }
        const text = encodeURIComponent(customText || "");
        const url = `https://wa.me/${num}?text=${text}`;
        window.open(url, "_blank");
      }

      // =========================
      // Supabase: profile / stores / orders
      // =========================
      async function fetchProfile(){
        const { data: ures, error: uerr } = await supabaseClient.auth.getUser();
        if(uerr) throw new Error(uerr.message);
        const uid = ures?.user?.id;
        if(!uid) return null;

        const { data, error } = await supabaseClient
          .from("profiles")
          .select("role, store_id, display_name")
          .eq("user_id", uid)
          .maybeSingle();

        if(error) throw new Error("profiles: " + error.message);
        if(!data) throw new Error("Profil introuvable (table profiles).");
        return data;
      }

      async function fetchStores(){
        const { data, error } = await supabaseClient
          .from("stores")
          .select("id,name,slug,email")
          .order("name");
        if(error) throw new Error("stores: " + error.message);
        storesCache = data || [];
      }

      function normalizeEmail(email){
        return (email || "").trim().toLowerCase();
      }

      function findStoreByEmail(email){
        const target = normalizeEmail(email);
        if (!target) return null;
        return storesCache.find(store => normalizeEmail(store.email) === target) || null;
      }

      async function fetchStoreByEmail(email){
        const target = normalizeEmail(email);
        if (!target) return null;
        const { data, error } = await supabaseClient
          .from("stores")
          .select("id,name,email")
          .eq("email", target)
          .maybeSingle();
        if (error) throw new Error("stores: " + error.message);
        return data || null;
      }

      async function getCurrentUserEmail(){
        const { data } = await supabaseClient.auth.getUser();
        return data?.user?.email || "";
      }

      async function ensureStoreId(email){
        if (myStoreId) return myStoreId;

        const userEmail = normalizeEmail(email || await getCurrentUserEmail());
        if (!userEmail) return null;

        if (!storesCache.length) await fetchStores();

        let matchedStore = findStoreByEmail(userEmail);
        if (!matchedStore) matchedStore = await fetchStoreByEmail(userEmail);
        if (!matchedStore?.id) return null;

        myStoreId = matchedStore.id;
        myStoreName = matchedStore.name || myStoreName;

        try{
          const { data } = await supabaseClient.auth.getUser();
          const uid = data?.user?.id;
          if (uid) {
            await supabaseClient
              .from("profiles")
              .update({ store_id: matchedStore.id })
              .eq("user_id", uid);
          }
        }catch(err){
          console.warn("store_id update failed:", err?.message || err);
        }

        return myStoreId;
      }

      function fillStoreSelect(){
        $("storeSelect").innerHTML = storesCache
          .map(s => `<option value="${s.id}">${escapeHtml(s.name)}</option>`)
          .join("");
        if(storesCache[0]) $("storeSelect").value = storesCache[0].id;
      }

      function getActiveAndHistory(list){
        const active = [];
        const history = [];
        for(const o of list){
          if(o.picked_up_at) history.push(o);
          else active.push(o);
        }
        return { active, history };
      }

      async function loadOrders(){
        setDebug("");
        setMsg("");

        let storeId = myStoreId;

        // ADMIN : si une boutique est s√©lectionn√©e, on filtre, sinon on affiche tout
        if (role === "admin") {
          storeId = $("storeSelect")?.value || ""; // peut √™tre vide
        }

        let query = supabaseClient
          .from("orders")
          .select("*")
          .order("created_at", { ascending: false });

        if (storeId) query = query.eq("store_id", storeId);

        const { data, error } = await query;
        if (error) { setDebug("orders: " + error.message); return; }

        ordersCache = data || [];
        render();
      }

      async function addOrder(){
        // ‚úÖ D√©terminer la boutique sur laquelle on ajoute
        let storeId = myStoreId;

        // ADMIN : doit choisir une boutique
        if (role === "admin") {
          storeId = $("storeSelect")?.value || "";
          if (!storeId) {
            alert("‚ö†Ô∏è Admin : s√©lectionne une boutique avant d‚Äôajouter une commande.");
            return;
          }
        }

        // SHOP : s√©curit√©
        if (!storeId) {
          const email = await getCurrentUserEmail();
          await ensureStoreId(email);
          storeId = myStoreId;
        }

        if (!storeId) {
          const email = await getCurrentUserEmail();
          alert(`‚ö†Ô∏è Boutique inconnue (storeId manquant).\nEmail connect√©: ${email || "inconnu"}\nV√©rifie que cet email correspond au champ email de la table stores, ou renseigne profiles.store_id.`);
          return;
        }

        const client = $("client").value.trim();
        const tel = $("tel").value.trim();
        const article = $("article").value.trim();
        const qty = Number($("qty").value || 1);
        const date = $("date").value;
        const statut = $("statut").value;
        const notes = $("notes").value.trim();
        const seller = $("seller").value;

        if (!client || !tel || !article) { setMsg("‚ö†Ô∏è Client, Num√©ro et Article obligatoires."); return; }
        if (qty <= 0) { setMsg("‚ö†Ô∏è Qt√© minimum = 1."); return; }

        setMsg("‚è≥ Ajout‚Ä¶");

        const payload = {
          store_id: storeId,
          client, tel, article, qty, date, statut, notes,
          seller,
          received_checked: false,
          updated_at: new Date().toISOString()
        };

        const { error } = await supabaseClient.from("orders").insert([payload]);
        if(error){
          setMsg("‚ùå " + error.message);
          setDebug("orders insert: " + error.message);
          alert("‚ùå Impossible d'ajouter : " + error.message);
          return;
        }

        setMsg("‚úÖ Ajout√©e.");
        resetForm();
        await loadOrders();
      }

      async function updateStatus(id, newStatus){
        if (!canWrite()) return;

        const seller = $("seller").value;
        const audit = { updated_at: new Date().toISOString() };
        if (isUuid(seller)) audit.updated_by = seller;

        const { error } = await supabaseClient
          .from("orders")
          .update({ statut: newStatus, ...audit })
          .eq("id", id);

        if(error){ alert("‚ùå " + error.message); return; }
        await loadOrders();
      }

      async function toggleReceived(id){
        if (!canWrite()) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if(!o) return;

        const newVal = !Boolean(o.received_checked);
        const seller = $("seller").value;
        const audit = { updated_at: new Date().toISOString() };
        if (isUuid(seller)) audit.updated_by = seller;

        const { error } = await supabaseClient
          .from("orders")
          .update({ received_checked: newVal, ...audit })
          .eq("id", id);

        if(error){ alert("‚ùå " + error.message); return; }

        await loadOrders();

        const updated = ordersCache.find(x => String(x.id) === String(id));
        if(updated && updated.received_checked){
          if (getWAPreviewMode() === "direct") {
            const msg = templateToMessage(getTemplateByKey("arrivee"), updated);
            openWhatsAppWithText(updated, msg);
          } else {
            showWAModal(updated);
          }
        }
      }

      function confirmDanger(msg){
        return confirm("‚ö†Ô∏è " + msg);
      }

      async function markPickedUp(id){
        if (!canWrite()) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if(!o) return;

        if (antiErrorOn() && !Boolean(o.received_checked)) {
          alert("‚ö†Ô∏è Coche d‚Äôabord la case ‚ÄúRe√ßu‚Äù.");
          return;
        }

        if (!confirmDanger("Confirmer : commande r√©cup√©r√©e / termin√©e ? (envoi √† l‚Äôhistorique)")) return;

        const seller = $("seller").value;
        const audit = { updated_at: new Date().toISOString() };
        if (isUuid(seller)) audit.updated_by = seller;
        const pickedBy = isUuid(seller) ? { picked_up_by: seller } : {};

        const { error } = await supabaseClient
          .from("orders")
          .update({
            picked_up_at: new Date().toISOString(),
            ...pickedBy,
            ...audit
          })
          .eq("id", id);

        if(error){ alert("‚ùå " + error.message); return; }
        await loadOrders();
      }

      async function deleteOrder(id){
        if (!canWrite()) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if(!o) return;

        if (antiErrorOn() && currentView === "active" && !Boolean(o.received_checked)) {
          alert("‚ö†Ô∏è Anti-erreur : impossible de supprimer tant que ‚ÄúRe√ßu‚Äù n‚Äôest pas coch√©.\n(Si tu veux vraiment, mets Anti-erreur sur OFF.)");
          return;
        }

        if (!confirmDanger("Supprimer d√©finitivement ?")) return;

        const { error } = await supabaseClient.from("orders").delete().eq("id", id);
        if(error){ alert("‚ùå " + error.message); return; }
        await loadOrders();
      }

      // =========================
      // WhatsApp modal
      // =========================
      function showWAModal(order){
        waPendingOrderId = order.id;

        $("waMeta").textContent = `Client: ${order.client || "-"} ‚Ä¢ Tel: ${order.tel || "-"} ‚Ä¢ Article: ${order.article || "-"}`;

        $("waTemplate").value = "arrivee";
        $("waText").value = templateToMessage(getTemplateByKey("arrivee"), order);

        $("waNoPreview").checked = (getWAPreviewMode() === "direct");

        $("waBackdrop").style.display = "flex";
      }

      function closeWAModal(){
        if ($("waNoPreview")?.checked) setWAPreviewMode("direct");
        else setWAPreviewMode("preview");

        $("waBackdrop").style.display = "none";
        waPendingOrderId = null;
      }

      function applySelectedTemplate(){
        const id = waPendingOrderId;
        if (!id) return;

        const o = ordersCache.find(x => String(x.id) === String(id));
        if (!o) return;

        const key = $("waTemplate").value;
        $("waText").value = templateToMessage(getTemplateByKey(key), o);
      }

      async function copyWAText(){
        const val = $("waText").value || "";
        try{
          await navigator.clipboard.writeText(val);
          alert("‚úÖ Message copi√©.");
        }catch{
          $("waText").select();
          document.execCommand("copy");
          alert("‚úÖ Message copi√©.");
        }
      }

      function confirmOpenWhatsApp(){
        const id = waPendingOrderId;
        if (!id) return closeWAModal();

        const o = ordersCache.find(x => String(x.id) === String(id));
        if (!o) return closeWAModal();

        openWhatsAppWithText(o, $("waText").value);
        closeWAModal();
      }

      // =========================
      // Settings modal
      // =========================
      function openSettings(){
        const s = loadSettings();
        $("setShopName").value = s.shopName || "";
        $("setHours").value = s.hours || "";
        $("setSignature").value = s.signature || "";

        $("tplArrivee").value = s.templates.arrivee || "";
        $("tplRupture").value = s.templates.rupture || "";
        $("tplRelance").value = s.templates.relance || "";
        $("tplPartiel").value = s.templates.partiel || "";

        $("settingsBackdrop").style.display = "flex";
      }
      function closeSettings(){
        $("settingsBackdrop").style.display = "none";
      }
      function resetSettingsDefaults(){
        if (!confirm("R√©initialiser tous les param√®tres et templates WhatsApp ?")) return;
        saveSettingsToStorage(structuredClone(DEFAULT_SETTINGS));
        openSettings();
        applySettingsToUI(myStoreName || null);
      }
      function saveSettings(){
        const s = loadSettings();
        s.shopName = $("setShopName").value.trim() || DEFAULT_SETTINGS.shopName;
        s.hours = $("setHours").value.trim();
        s.signature = $("setSignature").value.trim() || DEFAULT_SETTINGS.signature;

        s.templates.arrivee = $("tplArrivee").value;
        s.templates.rupture = $("tplRupture").value;
        s.templates.relance = $("tplRelance").value;
        s.templates.partiel = $("tplPartiel").value;

        saveSettingsToStorage(s);
        applySettingsToUI(myStoreName || null);
        alert("‚úÖ Param√®tres enregistr√©s.");
        closeSettings();
      }

      function resetForm(){
        $("client").value = "";
        $("tel").value = "";
        $("article").value = "";
        $("qty").value = 1;
        $("notes").value = "";
        $("statut").value = "Mettre en commande";

        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const dd = String(d.getDate()).padStart(2, "0");
        $("date").value = `${yyyy}-${mm}-${dd}`;

        setMsg("");
      }

      // =========================
      // Render
      // =========================
      function updateDashboard(activeList){
        let mec=0, com=0, rup=0, recu=0;
        for (const o of activeList){
          if (o.statut === "Mettre en commande") mec++;
          if (o.statut === "Commander") com++;
          if (o.statut === "Rupture de stock") rup++;
          if (Boolean(o.received_checked)) recu++;
        }
        $("statMEC").textContent = mec;
        $("statCOM").textContent = com;
        $("statRUP").textContent = rup;
        $("statRECU").textContent = recu;
      }

      function render(){
        const { active, history } = getActiveAndHistory(ordersCache);

        $("countActive").textContent = active.length;
        $("countHistory").textContent = history.length;
        updateDashboard(active);

        const q = ($("search").value || "").trim().toLowerCase();
        const filterStatus = $("filterStatus").value;

        const base = (currentView === "history") ? history : active;

        let list = base.filter(o=>{
          if(filterStatus && o.statut !== filterStatus) return false;
          if(!q) return true;
          return (
            (o.client || "").toLowerCase().includes(q) ||
            (o.tel || "").toLowerCase().includes(q) ||
            (o.article || "").toLowerCase().includes(q) ||
            (o.notes || "").toLowerCase().includes(q)
          );
        });

        // en cours : re√ßu en haut
        if(currentView === "active"){
          list = [...list].sort((a,b) => (Boolean(b.received_checked) - Boolean(a.received_checked)));
        }

        $("countShown").textContent = list.length;

        const tbody = $("tbody");
        tbody.innerHTML = "";

        for(const o of list){
          const tr = document.createElement("tr");

          const since = timeSince(o.created_at || o.createdAt);
          const receivedPill = (currentView === "active" && Boolean(o.received_checked))
            ? `<span class="pill receivedTag">RE√áU ‚úÖ</span>` : "";

          // ‚úÖ ADMIN ne voit rien
          const receivedControl = (currentView === "active" && role === "shop")
            ? `<label class="cb"><input type="checkbox" ${Boolean(o.received_checked) ? "checked":""} data-action="received" data-id="${o.id}"> Re√ßu</label>`
            : `<span class="small">‚Äî</span>`;

          const actionsShop = (currentView === "active")
            ? `
              <div class="actions">
                ${receivedControl}
                <button class="btnPrimary" data-action="picked" data-id="${o.id}">Commande r√©cup√©r√©e</button>
                <button class="btn btnDanger" data-action="delete" data-id="${o.id}">Supprimer</button>
              </div>
            `
            : `
              <div class="actions">
                <button class="btn btnDanger" data-action="delete" data-id="${o.id}">Supprimer</button>
              </div>
            `;

          const actionsAdmin = `<div class="small">Lecture</div>`;

          tr.innerHTML = `
            <td>
              <span class="pill">${escapeHtml(o.date || "")}</span><br/>
              <span class="small">${escapeHtml(since)}</span><br/>
              ${receivedPill}
            </td>

            <td>
              <b>${escapeHtml(o.client || "")}</b><br/>
              <span class="small">${escapeHtml(o.tel || "")}</span><br/>
              <div class="small">Cr√©√©e par: <b>${escapeHtml(o.seller || "-")}</b></div>
            </td>

            <td>
              ${escapeHtml(o.article || "")}<br/>
              <span class="small">Qt√©: ${Number(o.qty || 1)} ‚Ä¢ Vendeur: ${escapeHtml(o.seller || "-")}</span>
            </td>

            <td>
              <span class="pill ${statusClass(o.statut)}">${escapeHtml(o.statut || "")}</span>
              <div style="margin-top:6px">
                <select ${role !== "shop" ? "disabled" : ""} data-action="status" data-id="${o.id}">
                  ${["Mettre en commande","Commander","Rupture de stock","Re√ßu partiellement"].map(s => `
                    <option ${o.statut===s ? "selected":""}>${escapeHtml(s)}</option>
                  `).join("")}
                </select>
              </div>
            </td>

            <td>${escapeHtml(o.notes || "")}</td>

            <td>${role === "shop" ? actionsShop : actionsAdmin}</td>
          `;

          tbody.appendChild(tr);
        }
      }

      // =========================
      // Enter app
      // =========================
      function initUsers(){
        $("seller").innerHTML = USERS.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`).join("");
        $("seller").value = USERS[0];
      }

      async function enterApp(email){
        showApp(email);

        initUsers();
        setTodayDefault();
        resetForm();

        // üîê Charger le profil
        profile = await fetchProfile();
        role = profile.role || "shop";
        myStoreId = profile.store_id || null;

        const { data: u } = await supabaseClient.auth.getUser();
        const uid = u?.user?.id || "-";

        setDebug(`DEBUG: email=${email} | role=${role} | storeId=${myStoreId} | uid=${uid}`);

        await fetchStores();

        if(role === "admin"){
          $("uiSub").textContent = "ADMIN ‚Äì toutes boutiques";
          show($("adminCard"), true);
          show($("addCard"), false);
          fillStoreSelect();
          await loadOrders();
        } else {
          // SHOP
          if(!myStoreId){
            await ensureStoreId(email);
          }
          if(!myStoreId){
            throw new Error("Ton profil n‚Äôa pas de store_id (profiles.store_id) et aucun store ne correspond √† ton email.");
          }

          const s = storesCache.find(x => x.id === myStoreId);
          myStoreName = s?.name || "Boutique";
          $("uiSub").textContent = myStoreName;

          applySettingsToUI(myStoreName);

          show($("adminCard"), false);
          show($("addCard"), true);

          await loadOrders();
        }
      }

      // =========================
      // Reset password
      // =========================
      async function sendReset(){
        try{
          setAuthMsg("");
          const email = $("email").value.trim();
          if(!email){
            setAuthMsg("‚ö†Ô∏è Mets l‚Äôemail puis clique ici.");
            return;
          }

          const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: SITE_URL + "/" });
          if(error){
            setAuthMsg("‚ùå " + error.message);
            return;
          }
          setAuthMsg("‚úÖ Email de r√©initialisation envoy√©.");
        }catch(e){
          setAuthMsg("‚ùå " + (e?.message || e));
        }
      }

      // =========================
      // Events
      // =========================
      $("btnLogin").addEventListener("click", login);
      $("btnLogout").addEventListener("click", logout);
      $("btnReset").addEventListener("click", sendReset);
      $("btnUpdatePass").addEventListener("click", updatePassword);

      $("btnAdd").addEventListener("click", addOrder);
      $("btnClear").addEventListener("click", resetForm);

      $("btnSettings").addEventListener("click", openSettings);

      $("btnCloseSettings").addEventListener("click", closeSettings);
      $("btnResetSettings").addEventListener("click", resetSettingsDefaults);
      $("btnSaveSettings").addEventListener("click", saveSettings);

      $("btnCloseWA").addEventListener("click", closeWAModal);
      $("btnCancelWA").addEventListener("click", closeWAModal);
      $("btnResetWA").addEventListener("click", applySelectedTemplate);
      $("btnCopyWA").addEventListener("click", copyWAText);
      $("btnOpenWA").addEventListener("click", confirmOpenWhatsApp);
      $("waTemplate").addEventListener("change", applySelectedTemplate);

      $("waBackdrop").addEventListener("click", closeWAModal);
      $("settingsBackdrop").addEventListener("click", closeSettings);

      $("tabActive").addEventListener("click", ()=>{
        currentView="active";
        $("tabActive").classList.add("active");
        $("tabHistory").classList.remove("active");
        render();
      });
      $("tabHistory").addEventListener("click", ()=>{
        currentView="history";
        $("tabHistory").classList.add("active");
        $("tabActive").classList.remove("active");
        render();
      });

      $("search").addEventListener("input", render);
      $("filterStatus").addEventListener("change", render);

      $("btnReloadAdmin").addEventListener("click", loadOrders);
      $("storeSelect").addEventListener("change", loadOrders);

      // Delegation actions table
      $("tbody").addEventListener("change", async (e)=>{
        const el = e.target;
        const action = el?.dataset?.action;
        const id = el?.dataset?.id;
        if(action === "status"){
          await updateStatus(id, el.value);
        }
      });

      $("tbody").addEventListener("click", async (e)=>{
        const el = e.target;
        const action = el?.dataset?.action;
        const id = el?.dataset?.id;

        if(action === "picked") await markPickedUp(id);
        if(action === "delete") await deleteOrder(id);
      });

      $("tbody").addEventListener("change", async (e)=>{
        const el = e.target;
        if(el?.dataset?.action === "received"){
          await toggleReceived(el.dataset.id);
        }
      });

      // ESC ferme les modals
      document.addEventListener("keydown", (e)=>{
        if (e.key !== "Escape") return;
        if ($("waBackdrop").style.display === "flex") closeWAModal();
        if ($("settingsBackdrop").style.display === "flex") closeSettings();
      });

      // Debug global erreurs
      window.addEventListener("error", (e) => setDebug("JS error: " + (e.message || "inconnue")));
      window.addEventListener("unhandledrejection", (e) => setDebug("Promise error: " + (e.reason?.message || e.reason || "inconnue")));

      // =========================
      // Auth listener + boot
      // =========================
      supabaseClient.auth.onAuthStateChange(async (_event, session) => {
        if (isLoggingOut) return;

        // ‚úÖ si recovery => on ne doit PAS auto-enterApp
        if (isRecoveryFlow()) {
          showLogin();
          show($("resetCard"), true);
          allowAutoLogin = true; // autorise updateUser
          return;
        }

        const user = session?.user;

        if (!user) { showLogin(); return; }
        if (!allowAutoLogin) { showLogin(); return; }

        if (hasBooted) return;
        hasBooted = true;

        try{
          await enterApp(user.email || "connect√©");
        }catch(err){
          console.error(err);
          alert("‚ùå " + (err?.message || err));
          showLogin();
          hasBooted = false;
        }
      });

      // Boot
      (async ()=>{
        // ‚úÖ si lien recovery : rester sur login + resetCard
        if (isRecoveryFlow()) {
          allowAutoLogin = true;
          showLogin();
          show($("resetCard"), true);
          return;
        }

        const { data } = await supabaseClient.auth.getSession();

        if (isLoggingOut) { showLogin(); return; }

        if (data?.session?.user) {
          if (!allowAutoLogin) { showLogin(); return; }
          if (!hasBooted) {
            hasBooted = true;
            try{
              await enterApp(data.session.user.email || "connect√©");
            }catch(err){
              console.error(err);
              alert("‚ùå " + (err?.message || err));
              showLogin();
              hasBooted = false;
            }
          }
        } else {
          showLogin();
        }
      })();

    })();
    </script>

  </div>
</body>
</html>
